# Story 2.4: Force Allocation Service

## Status
Approved

## Story
**As a** order processing system,  
**I want** to perform force allocation bypassing stock validation,  
**so that** QC SMF orders are immediately allocated for fulfillment.

## Acceptance Criteria
1. Stock validation bypass implementation (IsForceAllocation=True enforcement)
2. Inventory allocation from specified ShipFromLocationID for all line items
3. Order status update to 2000 (Allocated) upon successful allocation
4. Allocation audit logging with timestamp and location tracking (Enhanced: Add workflow step timing and payload compliance audit)
5. Line item allocation tracking with individual allocation records
6. Error handling for allocation failures with proper error messaging
7. Allocation reversal capability for failed downstream processing
8. Multi-location allocation support for line items from different locations
9. Allocation event publishing to order.status.v1 Kafka topic for coordination
10. Force allocation processing completed within <25ms per order

## Tasks / Subtasks

- [ ] Implement Stock Validation Bypass (AC: 1)
  - [ ] Create IsForceAllocation=True enforcement logic
  - [ ] Implement stock validation bypass for QC SMF orders
  - [ ] Set up force allocation validation and verification
  - [ ] Create force allocation business rule enforcement

- [ ] Implement Inventory Allocation by Location (AC: 2)
  - [ ] Create inventory allocation from ShipFromLocationID
  - [ ] Implement location-based allocation logic
  - [ ] Set up allocation quantity and availability tracking
  - [ ] Create location allocation validation

- [ ] Implement Order Status Update to Allocated (AC: 3)
  - [ ] Update order status to 2000 (Allocated) on success
  - [ ] Implement atomic status update with allocation
  - [ ] Set up status change validation and verification
  - [ ] Create status update audit logging

- [ ] Implement Enhanced Allocation Audit Logging (AC: 4)
  - [ ] Create comprehensive allocation audit trail with workflow step timing
  - [ ] Implement timestamp and location tracking with <25ms performance validation
  - [ ] Set up allocation activity logging with ExpectedPublishOrder.json payload compliance
  - [ ] Create allocation audit reporting with field name standardization (`IsForceAllocation`)
  - [ ] Add allocation step timing metrics for workflow performance monitoring

- [ ] Implement Line Item Allocation Tracking (AC: 5)
  - [ ] Create individual line item allocation records
  - [ ] Implement allocation quantity and status tracking
  - [ ] Set up line item allocation validation
  - [ ] Create allocation record management

- [ ] Implement Allocation Error Handling (AC: 6)
  - [ ] Create comprehensive error handling for allocation failures
  - [ ] Implement proper error messaging and guidance
  - [ ] Set up allocation failure monitoring and alerting
  - [ ] Create allocation error recovery procedures

- [ ] Implement Allocation Reversal Capability (AC: 7)
  - [ ] Create allocation reversal for failed processing
  - [ ] Implement allocation rollback procedures
  - [ ] Set up reversal audit logging and tracking
  - [ ] Create allocation recovery and cleanup

- [ ] Implement Multi-Location Allocation Support (AC: 8)
  - [ ] Support line items from different locations
  - [ ] Implement cross-location allocation coordination
  - [ ] Set up multi-location allocation validation
  - [ ] Create location allocation optimization

- [ ] Implement Allocation Event Publishing (AC: 9)
  - [ ] Publish allocation events to order.status.v1 topic
  - [ ] Implement Kafka event publishing for coordination
  - [ ] Set up allocation event formatting and validation
  - [ ] Create allocation event monitoring

- [ ] Optimize Force Allocation Performance (AC: 10)
  - [ ] Implement efficient allocation algorithms
  - [ ] Optimize allocation processing and validation
  - [ ] Set up allocation performance monitoring
  - [ ] Validate <25ms processing time requirement

## Dev Notes

### Previous Story Context
Story 2.4 follows financial calculations (Story 2.3) and implements the fourth step of the 9-step order processing workflow, performing force allocation for QC SMF orders.

### Technical Architecture Context
[Source: PRD Epic 2 - Order Processing Engine]
- **Force Allocation**: IsForceAllocation=True bypass for QC SMF requirements
- **Location-Based**: Allocation from specified ShipFromLocationID
- **Status Update**: Order status 2000 (Allocated) upon successful allocation
- **Performance**: <25ms per order allocation processing

### Technology Stack Requirements
[Source: PRD Service Architecture]
- **Database**: PostgreSQL for allocation records and status tracking
- **Messaging**: Kafka event publishing for allocation coordination
- **Validation**: Allocation validation and business rule enforcement
- **Audit**: Comprehensive allocation audit trail and logging

### Performance Requirements
[Source: PRD Non-Functional Requirements]
- Force allocation processing within <25ms per order
- Support for 1000+ orders per minute allocation capacity
- Multi-location allocation support for complex orders
- Allocation reversal capability for error recovery

### Force Allocation Architecture
[Source: PRD Epic 2 Context]
The force allocation service provides:
- Stock validation bypass for QC SMF operational requirements
- Location-based inventory allocation with audit trails
- Order status progression to Allocated (2000)
- Multi-location support for complex order scenarios

### QC SMF Allocation Requirements
[Source: PRD Functional Requirements]
- **IsForceAllocation**: Must be True for all QC SMF orders
- **Location Consistency**: Allocation from specified ShipFromLocationID
- **Status Progression**: 1000 (Open) â†’ 2000 (Allocated)
- **Multi-Location**: Support for line items from different locations

### Testing Standards

#### Testing Requirements
[Source: PRD Testing Strategy]
- Unit testing for force allocation logic and validation
- Integration testing for multi-location allocation scenarios
- Performance testing to validate <25ms allocation target
- Event publishing testing for Kafka coordination

#### Test File Locations
- Unit tests: `src/allocation/__tests__/`
- Integration tests: `tests/integration/allocation/`
- Performance tests: `tests/performance/allocation/`

#### Testing Frameworks
- Jest for unit and integration testing
- Custom allocation testing utilities
- Kafka event testing for coordination validation
- Load testing for allocation performance

## Dev Agent Record

### Agent Model Used
(To be populated by dev agent during implementation)

### Debug Log References
(To be populated by dev agent during implementation)

### Completion Notes List
(To be populated by dev agent during implementation)

### File List
(To be populated by dev agent during implementation)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-12 | 1.0 | Story created from Epic 2.4 requirements | Sarah (PO Agent) |