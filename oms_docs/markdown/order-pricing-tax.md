# Tax

**Permalink:** order-pricing-tax
**Path:** Manhattan Active® Omni/Order Management/Process & Configuration Guides/Order Selling/Order Pricing/Tax
**Content Length:** 88,493 characters
**Scraped:** 2025-08-09T21:58:29.639347

---

Home ››Manhattan Active® Omni››Order Management››Process & Configuration Guides››Order Selling››Order Pricing ››Tax Tax Next Enabling TaxTax Request & ResponseTax Request MappingsTax CodeQuotation Tax RequestsInvoice Tax RequestsTax CalculationTax Calculation for Order CreationTax Calculation for Order UpdatesTax Calculation for Shipping Address Update and Write-offTax Calculation for InvoicesShipment & Adjustment Invoice Tax ModesTax Comparison StrategyTax Calculation for Returns & ExchangesTax OverridesInformational TaxUsing informational taxTax Rate BreakupTax Break Up ConfigurationTax ExemptionTax Exemption After Order Is FulfilledEligibility for Tax Exemption After Order Is FulfilledTax FailoverTax Failover ProcessTax Failover ConfigurationImplementation FlavorsHow to use tax failover with the Calculate Tax user exit?How to leverage a tax gateway to charge the Colorado delivery fee?How to use the tax exemption feature if a retailer is using a third party tax provider other than base integrated tax provider Vertex?How to use multiple tax code corresponding to a single chargeHow to communicate differences in quotation and invoice tax to the tax provider when using minimum tax modeTroubleshootingTax is being reduced on shipment invoicingWhen importing an order with IsTaxExempt set to true, the tax on the order is not Auth reversingWhy does overriding the item price increase the tax instead of reducing it?The taxable amount and tax amount for the appeasement do not match in some scenariosWhy is return invoice tax call made on even exchanges when PreInvoiceTaxCall user exit is implementedTax is not recalculated correctly upon order modification when the order contains discountsWhy do I see a difference in tax charged when using the "TaxCode" tax comparison strategy?When using a third-party tax provider, which fields are mandatory under OrderLineTaxDetail per base to be sent to Active Omni? Is it Tax Rate and Tax Type ID?Related Articles Overview The Order component manages tax for customer transactions, including customer orders, returns, exchange orders, adjustments, and POS transactions. Out of the box integration exists with third-party tax provider Vertex, but custom translations can be built to integrate with other tax providers. Vertex maintains updated tax rates for the jurisdictions in which the transactions occur, and the Order component makes real-time web service calls to Vertex to retrieve tax information. The Order component makes calls to Vertex at three points during the order life cycle: when the order is captured, when the order is updated, and when each item is fulfilled. These three different tax calls are categorized into two types of tax requests which are sent to Vertex: Quotation and Invoice. Details of each tax request type is described below. In an order, the taxes can be applied at the header or line level: Header level taxes are usually taxes applied on header level charges. They will be prorated at the line level using the same proration logic as the charges. Header level charges will be found in the "OrderTaxDetail" array. Line level taxes are applied on line level charges, VAS and item price. They can be found in the "OrderLineTaxDetail" array along with the prorated header charges. In the same tax array, it is possible to find multiple tax details that will be summed into the total tax field at the line level. At the header level, the total tax will contain the sum of the total line tax + the sum of the tax detail under the order tax detail array. Important Note: Each tax detail contains, among other things, a TaxCode, a TaxTypeId, a Jurisdiction, a JurisdictionTypeId and a FulfillmentGroupId (optional) Only one record per tax array with the same combination of these 5 fields is supported. Tax computation at order line level is not supported out of the box. Enabling Tax When tax is enabled, the Order component calculates quotation taxes and invoice taxes based on the logic described in this guide. When tax is disabled, no quotation tax calls or invoice tax calls are made. Tax should be disabled only if taxes are already calculated and populated on an order before being sent to Order component. Tax calculation can be enabled or disabled by order type in the Order Configuration UI. The reason being, most e-commerce and point of sale (POS) orders require tax calculations, but most retail replenishment orders do not. To accommodate this, the Order Configuration for e-commerce and POS orders can have tax enabled, while the Order Configuration for replenishment orders can have tax disabled. To update the setting which enables and disables tax calculation for a set of order types, navigate to the Order Configuration UI and select the Tax check box. Third party Tax configuration - VertexAn endpoint and credentials must be configured for the third party tax provider, such as Vertex. In the configuration repository specific to project team (typically maintained by Ops), under the "Config" directory, create a new folder called "com-manh-cp-vertex". Within the folder create a new file called "application.properties". Within the property file add the following two properties: vertexComponent.vertexEndPointURL = http://vertexURL/vertex-ws/services/CalculateTax70 vertexComponent.vertexTrustId = yourVertexTrustIdHere ribbon.ReadTimeout = 3000 ribbon.ConnectTimeout = 3000 The timeout setting of 3000 is a recommended value. Work with your Vertex support team to fine tune this for your project as required. Note: Configuration to connect to Vertex is picked up from the property file, not from the Vertex tax gateway entity. In the configuration repository - "Config" directory, create a new folder called "com-manh-cp-vertex". Within the folder create a new file called "application.properties". Within the property file, add the following two properties: vertexComponent.vertexEndPointURL & vertexComponent.vertexTrustId In case different Vertex EndPoints are to be used by different organizations, the above mentioned properties can be qualified with the OrdId as mentioned below. vertexComponent.vertexEndPointURL.orgId vertexComponent.vertexTrustId.orgId vertexComponent.xmlns.orgId For example, if you have two different Organizations ID's - ecomorg and retailorg, the name of the properties will be vertexComponent.vertexEndPointURL.ecomorg vertexComponent.vertexTrustId.ecomorg vertexComponent.xmlns.ecomorg vertexComponent.vertexEndPointURL.retailorg vertexComponent.vertexTrustId.retailorg vertexComponent.xmlns.retailorg Note: If the above properties are not qualified with the orgId, all the organizations will use the same configuration. Vertex configuration: The Vertex Customer Portal enables retailers to configure tax rules for tax categories, which are groups of items that follow the same taxing rules, or individual items. If a tax rule exists for an individual item which is also part of a tax category, then the item-level tax rates override the category-level tax rates. Since the Order component uses product class to populate the tax category field in the tax request, retailers should configure their Vertex data accordingly. To enable support for Version 9.0 of Vertex® Indirect Tax O Series®, the respective properties for Vertex Integration have to be changed in the Vertex Configuration repository. To migrate to Vertex9.0, In configuration repo vertexComponent.vertexEndPointURL: <Vertex_9.0URL> vertexComponent.vertexTrustId: <Vertex_9.0TrustId> vertexComponent.xmlns: urn:vertexinc:o-series:tps:9:0 Tax Request & Response The tax request is sent to Vertex as an XML within a SOAP envelope. Based on the information in the request, Vertex sends a tax response with taxes for each taxable line item and each tax jurisdiction. The tax request is formed based on the following logic: Each order line is included in the tax request as a line item. The order line product class is included in the tax request and is used to determine tax rates in Vertex. The order line extended price is calculated as Extended Price = (Unit Price * Quantity) - Line Discounts, where line discounts are prorated for invoiced quantity in the invoice tax request. This includes only line discounts which are not applied against charges. Each charge is included in the tax request as a line item. The charge line extended price is calculated as Extended Price = Charge Total - Line Discounts, where the charge and discount have the same tax code. The charge detail tax code is included in the tax request and is used to determine tax rates in Vertex. For imported charges, the tax code is populated by an external system. For shipping charges, return shipping charges, and return fees calculated by the Order component or S&H component, the tax code is populated based on the charge type configuration. For return charges, tax is included in the charge and isTaxIncluded is set to true in the Vertex request, so that Vertex can back-calculate taxes for the charge based on the tax rate. For example, if the restocking fee is $5, then that $5 is assumed to include tax, so that we charge the customer only $5 at the time of return invoice creation. When a return invoice tax call is made, if Vertex has a 10% tax rate for this charge, then tax is back-calculated as $0.45, and that tax is saved as informational to indicate that it does not need to be added to the order totals. Refer to the Vertex Configuration section for details of the required configuration within Vertex. Tax Request Mappings If one order is going to two different destinations and has a header shipping charge, then an address is randomly selected from one line to calculate tax for the shipping charge. For example, if one line is shipping to Tennessee and another line to New York; but a single header shipping charge exists, then the system randomly chooses either Tennessee or New York to use as the destination for the shipping charge for tax purposes. Return charges copied from the parent order use destination = shipFromAddress. Return charges (header or line) use destination = shipToLocation. Tax Code Tax code is a required attribute on the charge detail entity that's used to form the tax request. It is used to group discounts to the corresponding charges/line items (example, shipping discounts). When the tax response is received, the tax code is saved on the tax detail. If tax is disabled (taxes are already calculated), then Tax Code must be populated in the Tax Detail as well as the Charge Detail upon initial order save. Example of how tax code worksFor example: OrderLine: Item A, $100 Line S&H ChargeDetail: TaxCode = Shipping, $10 When the tax request is sent, taxable entities (different charge types and discounts) are grouped using tax code, so the request is sent as: Taxable line item 1: Item A, TaxableAmount = $100 Taxable line item 2: TaxCode = Shipping, TaxableAmount = $10 The tax engine responds with tax calculated as: Tax detail for item 1: 5%, $5 tax, TaxCode = null Tax detail for S&H: 6%, $0.60 tax, TaxCode = Shipping Tax code is also used to group discounts against charges in the tax request. Another example with discounts: OrderLine: Item A, $100 Line S&H ChargeDetail: TaxCode = Shipping, $10 Line S&H discount ChargeDetail: TaxCode = Shipping, -$6 When the tax request is sent, taxable entities (different charge types and discounts) are grouped using tax code, so the request is sent as: Taxable line item 1: Item A, TaxableAmount = $100 Taxable line item 2: TaxCode = Shipping, TaxableAmount = $4 (the calculation adds all charge details with TaxCode = Shipping, so 10 - 6 = 4) The tax engine responds with tax calculated as: Tax detail for item 1: 5%, $5 tax, TaxCode = null Tax detail for S&H: 6%, $0.24 tax, TaxCode = Shipping Tax code can be populated on each charge detail in a few ways: Tax code can be passed on the order import for orders created in e-commerce or external channels If tax code is null on a charge detail when it's saved, then it is populated based on the value configured in the system. The system populates this value based on the Tax Code Override value if it's configured for the given charge type. If the Tax Code Override is not configured for the charge type, then the tax code is pulled from the Charge Type entity. The values on the Charge Type entity cannot be modified, so use the Tax Code Override UI to configure your own tax codes for each charge type. For related charges (DiscountOnId = Charges), the tax code will be overwritten with the tax code of the corresponding related charge detail, irrespective of the imported tax code value. This is done so related charges have matching tax codes and are grouped properly in the tax gateway. (example, a discount on shipping charges should have TaxCode = Shipping). Note : In order to not force the system to update the taxCode in discount entity, one can override the ChargeTypeId to "Promotion" in taxCodeOverride entity to return the original tax code value. It can be done with the below API : POST - url/order/api/order/taxCodeOverride/save Tax codes can be any value, but they should be defined as categories because they map to taxability categories in the third-party tax engine. For example, tax code 'Shipping' would follow freight tax laws when it gets to the tax engine, but 'Shipping_123' on one order and 'Shipping_456' on the next order would not map to any taxability category and would cause issues. Quotation Tax Requests When an order is created or updated, a quotation tax request is made to retrieve estimated taxes. For example, when a customer places an order on e-commerce, the website indicates that the customer owes $7.98 in estimated taxes. Quotation taxes are not written to the retailer’s tax ledger but are used to give the customer an estimated tax amount. The quotation tax request contains the order object since no items have been fulfilled yet. This order contains planned shipments (allocations) which can be used to estimate the tax from the ship-from facility to the customer's destination. Upon receiving a quotation tax response from Vertex, the following updates occur on the order: Header taxes are saved and prorated across order lines, header total taxes are updated, and order total are updated Line level taxes are saved, line total taxes are updated, and line totals are updated Invoice Tax Requests Since tax rates can change between the times that an order was placed and when the order is fulfilled, the Order component makes a call at the time of invoicing. The invoice tax request is made using the invoice object, which contains all items on a shipment. For example, when a customer's e-commerce order ships, the tax on that order is re-calculated based on the ship date. If an order is fulfilled in multiple shipments, then an invoice tax call is made for each invoice, in order to get the tax rates at the time of invoicing. Based on configuration, the customer can be charged tax based on the quotation tax, the invoice tax, or the minimum of the quotation and invoice tax. Invoice Tax Request Date Mapping Vertex Line Item Type Tax Date Sale order line Invoice.FulfillmentDate (shipped date) Sale line charges Invoice.FulfillmentDate (shipped date) Return order line InvoiceLine.FulfillmentDate (original shipped date) Return line charge copied from parent order InvoiceLine.FulfillmentDate (original shipped date) Return header or line fees Invoice.CreatedDate (return date) If Invoice Tax Call was missed during Invoice creation. It can achieved with below steps, 1.Make CalculateTaxable call for the required Invoice {{url}}/order/api/order/invoice/calculateTaxableAmount 2.Make Vertex Invoice Tax Call {{url}}/vertex/api/vertex/tax/invoice Tax Calculation Tax Calculation for Order Creation When an order is imported from third party systems such as e-commerce, it is expected that quotation tax has already been estimated and is included on the order. The third-party system should request a separate tax rate for each line item and for each different charge on the order, as tax rates for charges such as shipping and services differ from sales tax rates. The order can contain line-level and order-level taxes. If tax is not calculated by an external system, then an order can be imported with the isAlreadyTaxed attribute set to false, which triggers a quotation tax call upon order creation. When an order is created in the call center UI, the Order component makes a quotation tax call to the third-party tax provider such as Vertex and saves the estimated taxes on the order. The estimated taxes are used to determine the order total, and the customer provides payment for the estimated tax amount. Tax rates are calculated for the order based on the item, price, product class, ship from address, ship-to address, and any rules maintained in the third-party tax system. When an item is added to an order, the order modification configuration triggers a tax calculation, which makes a real-time web service call to Vertex. By sending a request type of 'Quotation', the Order component communicates to Vertex that the taxes should be calculated, but not journalized. Tax Calculation for Order Updates Each time an order is updated, and the order modification configuration denotes that tax should be recalculated, then a web service call to Vertex is made to re-evaluate the estimated taxes based on the order updates. Tax requests triggered by order modifications contain request type ‘Quotation’, so that Vertex will calculate the taxes but not journalize them. For example: When the shipping method is updated from ground to overnight, the update shipping method order modification configuration triggers recalculation of S&H and taxes. When the shipping address is updated from Georgia to Nebraska, the update shipping address order modification configuration recalculates S&H and taxes for the new ship-to destination. When a CSR overrides the item price from $99 to $79, the price override order modification configuration recalculates tax based on the updated price. It is recommended that tax is always re-calculated when any order dollar values are updated. However, this service can be removed if the business opts not to recalculate tax in certain scenarios. See the Order Modification Configuration guide for details. Note:  Tax recalculation is not supported when appeasement is applied for orders before shipment and for the orders that are already shipped Tax Calculation for Shipping Address Update and Write-off If the shipping address is updated on the order line, the retailer can configure the system to recalculate tax by enabling Calculate Tax service for Update Address mod type at the order line level on order configuration, and the system will recalculate the tax by considering the new shipping address. Auto Write-off for Post Release Address Update The retailers can configure the system to automatically write off the additional taxes calculated. To write-off the additional tax calculated due to the shipping address update after the order is released, enable the "Auto Write-Off Additional Taxes" configuration available on the Order Configuration UI. Refer to Enabling auto write off additional taxes for more details on the configuration. Note: Additional taxes will be written-off only if the address is updated post release and there is additional tax levied, which leads to an increase in order total as compared to the order total before the new address was updated. Threshold-Based Auto Write-off for Address & Pick-Up Location Changes (Pre/Post-Release) Retailers can configure the system to automatically write off additional tax amounts resulting from shipping address or pickup location (ShipToLocationId) updates, whether pre-release or post-release, based on a defined threshold. To enable this, specify the threshold amount in the Order Configuration UI. If the additional tax is less than or equal to the configured threshold, it will be automatically written off. If it exceeds the threshold, the tax amount will be collected from the customer. For example, if the threshold is set to 0.99 and an address update results in an additional tax of 0.70, the system will write off the tax. However, if the additional tax is greater than 0.99, it will be charged to the customer. Refer to "Auto Write-Off Additional Taxes Threshold Amount" for more details on the configuration. Note: If both 'Auto Write-off for Post Release Address Update' and 'Auto Write-Off Additional Taxes Threshold Amount' are configured, the Auto Write-Off Additional Taxes Threshold will take precedence and be honored. How Auto Write-off Works? The write-off is performed immediately after the taxes are recalculated and the system creates the necessary tax write-off records in the order tax detail or the order line tax detail. To create the write-off tax detail record, each tax code is compared with the tax detail record that is returned by the tax engine after the tax is recalculated post release address update. A negative amount tax write-off details are created if the new tax calculated for a tax code is more than the already existing tax amount, and a positive amount tax write-off details are created if the new tax calculated is less than the already existing tax amount. Given below is a sample of the same. { "VatTaxCode": null, "IsInvoiceTax": true, "CreatedTimestamp": "2023-07-31T08:56:39.212", "TaxTypeId": "WriteOff", "TaxIdentifier5": null, "TaxIdentifier4": null, "JurisdictionTypeId": "WriteOff", "Process": "/order/save", "NonTaxableAmount": null, "UpdatedBy": "admin@ecomorg.com", "HeaderTaxDetailId": null, "TaxAmount": -0.30, "TaxCode": "null", "RateClassification": null, "TaxDate": null, "TaxRate": 1.0, "TaxRatePercent": "100", "PurgeDate": null, "UpdatedTimestamp": "2023-07-31T08:56:39.212", "CreatedBy": "admin@ecomorg.com", "TaxDetailId": "eec35fcf-1b7a-476e-bff3-d66c7a0cdfa0", "TaxableAmount": -0.30, "IsRetailDeliveryFee": false, "TaxEngineId": null, "Jurisdiction": "WriteOff", "FulfillmentGroupId": "2af9aa50aa816ef94788fa5b678ff5b5", "OrgId": "ecomorg", "IsInformational": false, "TaxIdentifier3": null, "ContextId": "0fd6cf23-7b13-4411-b30a-8f1d33d8ae77", "TaxIdentifier2": null, "TaxIdentifier1": null, "PK": "6907937992122913133", "TaxGateway": "WriteOff", "Unique_Identifier": "6907937992122913133__eec35fcf-1b7a-476e-bff3-d66c7a0cdfa0" } Note: The tax write-off is only to make sure the order total is not increased due to recalculation of taxes post release address update so that the customer is not charged any additional taxes. If the order total is reduced, since the new tax calculated is less than the taxes already existing on the order, the order total will be reduced accordingly and a refund is initiated back to the customer. Note: Irrespective of the tax write-off, the new tax amount will still be reported to the tax engine and the retailer will have to bear the tax that was written-off since the customer will not be paying it. Tax Calculation for Invoices Each time an invoice is created, the Order component makes an invoice tax request to the third-party tax provider to calculate the final tax amounts. Invoice tax calls are made when shipment, adjustment, and return invoices are created. Like the quotation tax call, the invoice tax call calculates tax based on item, price, product class, ship from address, ship to address, and any rules maintained in the third-party tax system. However, when an invoice tax call is made, the ship from address is known, since the shipment contained a ship-from location. This differs slightly from the quotation tax call, which uses the allocation entity to estimate the ship-from location. By sending a request type of 'Invoice', the Order component communicates to Vertex that the taxes should be calculated and journalized, which means that the taxes are recorder on the ledger. Shipment & Adjustment Invoice Tax Modes Tax rates can change between the time when an order is placed and when the items are shipped, and there are many different ways for businesses to handle these differences. The Order component provides four options for retailers to choose the tax mode which best suits their business. Based on the tax mode selected, the Order component calculates the amount owed by the customer at the time of invoicing. Note: Customers can change invoice tax modes based on their business needs. However, changing the tax mode in between an order cycle may cause undesired results. The following tax modes are used for shipment and adjustment invoices. Tax Mode Tax Mode Description System Behavior Example Minimum Charge the customer the lesser of the invoiced tax and quotation tax, if they differ. The Order component calls the tax engine to calculate invoice tax at the time of fulfillment, and the customer is charged the minimum of the quotation and invoice tax amounts. For example, if a customer is quoted $3 when they place an order, but the tax engine returns an invoice tax amount of $4 at the time of shipment, then the customer is charged $3, and the Order component saves the $4 for reporting purposes. If the customer is quoted $3 when they place an order, but the tax engine returns an invoice tax amount of $2 at the time of shipment, then the customer is charged $2. Quotation Ledger Charge the customer the amount which was originally quoted. Make an invoice tax call to create a journal entry when items are fulfilled. The Order component calls the tax engine to calculate invoice tax at the time of fulfillment, but the customer is always charged based on the quotation tax amounts. For example, if a customer is quoted $3 when they place an order, but the tax engine returns an invoice tax amount of $4 at the time of shipment, then the customer is charged $3, and the Order component saves the $4 for reporting purposes. If the customer is quoted $3 when they place an order, but the tax engine returns an invoice tax amount of $2 at the time of shipment, then the customer is charged $3, and the Order component saves the $2 for reporting purposes. Quotation Charge the customer the amount which was originally quoted. Do not make an invoice tax call. The Order component does not make any invoice tax call, but instead copies the quotation tax onto each invoice, prorated for the invoiced quantity. Since no journal entry is created for this order, the retailer is responsible for creating journal entries. For example, if a customer is quoted $3 when they place an order, then the customer is charged $3 when the order ships. Invoice Charge the customer the amount, which is calculated at the time of shipment, even if it is less than or greater than the quoted amount. The Order component calls the tax engine to calculate invoice tax at the time of fulfillment, and the customer is charged the invoice tax amount. If the invoice tax is greater than the order tax, then the customer must provide additional payment information. If the invoice tax is less than the order tax, then the customer is charged the lesser amount. For example, if a customer is quoted $3 when they place an order, but the tax engine returns an invoice tax amount of $4 at the time of shipment, then the customer must provide payment for the additional $1, to pay a total of $4. If the customer is quoted $3 when they place an order, but the tax engine returns an invoice tax amount of $2 at the time of shipment, then the customer is charged $2. The invoice and return tax mode can be configured in the Tax section of the Order Configuration UI. Tax Comparison Strategy To arrive at the final tax amount that has to be charged to the customer or make a journal entry at the time of shipment invoice or adjustment invoice creation depending on the various Tax Modes explained above, system has to compare quotation tax amount with invoice tax amount. To accomplish this comparison, the system compares each quotation tax detail record (order tax detail) with all the invoice tax detail records to find a matching record that can be compared with each other. The quotation tax detail record (order tax detail) and invoice tax detail records are compared for a match by considering a defined set of attributes from the record, which determines if a quotation tax detail record (order tax detail) matches with an invoice tax detail record, so that the tax amounts can then be eventually compared with each order to determine which is the minimum out of both. This is called the 'Tax Comparison Strategy' which is broadly categorized as 'Jurisdiction' and 'Tax Code'. The 'Jurisdiction' - Tax Comparison strategy considers Jurisdiction and Jurisdiction Type while comparing a quotation tax detail record (order tax detail) with an invoice tax detail record along with other attributes and considers that a quotation tax detail record (order tax detail) matches with an invoice tax detail record only if Jurisdiction and Jurisdiction Type for both the record matches along with other attributes. For example, in the scenario mentioned below, the tax comparison strategy 'Jurisdiction' results in only one matching tax detail record for Jurisdiction Type State and Jurisdiction Texas ('Quotation Tax Detail Record - 1' =  'Invoice Tax Record - 1')  and for all other invoice tax detail records the application will consider that there are no matching records in quotation tax detail records and hence for them the tax amount is assumed to be '0' (zero). Quotation Tax Detail Records JurisdictionTypeId Jurisdiction TaxCode TaxAmount Quotation Tax Detail Record - 1 STATE TEXAS null 6.75 Quotation Tax Detail Record - 2 CITY HOUSTON null 1.08 Quotation Tax Detail Record - 3 TRANSIT_DISTRICT HOUSTON METROPOLITAN TRANSIT AUTHORITY null 1.08 Invoice Tax Detail Records JurisdictionTypeId Jurisdiction TaxCode TaxAmount Invoice Tax Record - 1 STATE TEXAS null 6.75 Invoice Tax Record - 2 CITY EL PASO null 1.08 Invoice Tax Record - 3 COUNTY EL PASO null 0.54 Invoice Tax Record - 4 TRANSIT_DISTRICT EL PASO CITY TRANSIT DEPARTMENT null 0.54 Due to the results of 'Jurisdiction' tax comparison strategy, the application charges the customer tax amount greater than '0' (zero) only for the matching invoice tax detail record. For other invoice tax detail records the application charges '0' (zero) tax amount since that is the minimum tax amount when matching quotation tax detail records and invoice tax detail record are compared with each other - if the invoice tax mode is 'Minimum'.  The application behaves in a similar way even for invoice tax modes Invoice and Quotation Ledger. The 'Tax Code' - Tax Comparison strategy does not consider Jurisdiction and Jurisdiction Type while comparing a quotation tax detail record (order tax detail) with an invoice tax detail record but considers the Tax Code attribute along with other attributes like Order Tax (isHeaderTax), Order Line Tax (isLineTax), Fulfillment Group, Tax Engine, Informational Tax (isInformational), Adjustment records created after Invoicing (isInvoiceTax), TaxIdentifier1, TaxIdentifier2, TaxIdentifier3, TaxIdentifier4, and TaxIdentifier5. A quotation tax detail record (order tax detail) matches with an invoice tax detail record only if the Tax Code for both the records matches along with all the other attributes, even though the Jurisdiction and Jurisdiction Type for both the records do not match. Note: All the attributes including the tax code should match exactly during comparison and a sub set of attributes is not considered. For example, considering the above mentioned scenario, the tax comparison strategy 'Tax Code' results in all the invoice tax detail records finding a matching quotation tax detail record, since they are compared with respect to the attribute Tax Code along with other attributes but ignores the attributes Jurisdiction Type and Jurisdiction. Due to the results of the 'Tax Code' tax comparison strategy, the application charges the customer tax amount greater than '0' (zero) for all the invoice tax detail records even for the invoice tax modes Minimum, Invoice and Quotation Ledger. The Tax comparison strategy can be configured in the Order Configuration UI. Tax Calculation for Returns & Exchanges When a return is created against an existing order, the original order taxes, charges, and discounts are copied to the return order line and prorated for the return quantity. No quotation tax call is made at the time of return order creation if the return is made against an existing order. If a customer orders an even exchange item, then the prorated taxes, charges, and discounts are copied from the parent order to the exchange order and prorated for the exchange quantity. No quotation tax call is made at the time of even exchange creation. If the customer orders an uneven exchange item, then a quotation tax call is made to estimate the taxes. When the return items are received at the return center, a return invoice is created and an invoice tax call is made to the third party tax provider. For example, a customer purchases an item and is charged $5 sales tax and $3 S&H tax. When the customer returns that item, the return order line is created with -$5 sales tax and -$3 S&H tax. This data is copied from the parent order, and no quotation tax call is made at the time of return order creation. When the customer's return items are received at the distribution center and a return invoice is created, then an invoice tax call is made. Return Invoice Tax Modes Each business has unique requirements for handling return order taxes. Two return invoice tax modes are provided to give retailers the flexibility to choose the mode which best suits their business. Based on the tax mode selected, the Order component decides whether a return invoice tax call is required. Return Tax Mode Return Tax Mode Description System Behavior Example ReturnOrder Refund the customer what was originally paid. Do not make an invoice tax call. The Order component does not call the tax engine at the time of invoicing. The customer is refunded tax based on the tax rates from the original order. For example, a customer is charged $3 in taxes when an order ships.  When a return is created against this order, a -$3 tax is copied to the return order. When the return order is invoiced, then the customer is refunded -$3. ReturnOrderLedger Refund the customer what was originally paid. Make an invoice tax call to record what the retailer needs to pay in each jurisdiction. The Order component calls the tax engine to calculate invoice tax, but the customer is refunded tax based on the tax rates from the original order. For example, a customer is charged $3 in taxes when an order ships. When a return is created against this order, a -$3 tax is copied to the return order. When the return order is invoiced and the tax engine returns a tax of -$2, then the customer is refunded -$3, and the -$2 is saved in the order for reporting purposes. The return tax mode can be configured in the Tax section of the Order Configuration UI Tax Overrides Tax overrides are an uncommon use case, where a user overrides the tax rate or amount and inputs a new rate or amount. Tax overrides are typically performed by store managers in scenarios where the tax engine could not be reached, or when a tax holiday occurs. The tax override can be percentage-based or given as a flat amount. Once tax has been overridden, the tax details provided by a third-party system (for example, Vertex) are replaced with new tax details based on the overridden value. Tax overrides are currently not supported in the call center UI, but they are supported in POS and can be passed into the order component from an external system. When tax for an order line is overridden, the Order component saves a new tax detail, which replaces taxes on the item and all line-level charges. When tax is overridden for an order, the new tax detail replaces taxes on all sale order lines, header charges, and line charges. The overridden tax value is prorated across lines and charges based on the weight of each line/charge. For example: A line has unit price $100 and a $10 VAS charge: If tax is overridden to 5% for the line, then tax details are created with $5 for the item, and $0.50 for the VAS charge. If tax is overridden to $11 for the line, then tax details are created with $10 for the item, and $1 for the VAS charge. For flat-rate overrides, the value gets prorated across all eligible items and charges. An order has two lines: Line 1 has unit price $100 and a $10 VAS charge Line 2 has unit price $200 A $15 S&H charge for the entire order If tax is overridden to 5% for the entire order, then tax details are created with $5 for line 1's item, $0.50 for line 1's VAS charge, $10 for line 2's item, and $0.75 for the header S&H charge If the tax is overridden, then the overridden tax value is used during invoicing. Overridden tax values are currently supported only for Invoice Tax Mode of "Quotation." Tax overrides are not supported for returns. If an order has sale and return items, then tax overrides are only applicable for sale items. Note: To prevent Taxes being overridden to an extremely high value, the application validates the total taxes on the order every time the order is created or saved after order updates, so that the total taxes on the order does not exceed a certain percentage of the sum of order sub total and total charges from which total discounts have been deducted. The percentage used to perform this validation can be configured in order.validPercentForTax property. By default, the value for this property is set to 50 - that is by default total taxes on the order cannot exceed 50% of the sum of order sub total and total charges from which total discounts have been deducted. If this validation fails, the order will not be saved. Informational Tax Some regions use a VAT (Value Added Tax) instead of adding additional tax amount at the time of invoicing based on the value of goods/services provided. In this case, the tax records created by the tax engine will be back-calculated based on the tax rate and item or charge value, and displayed as tax records on the order with the IsInformational flag set to true. For example: Consider an order line worth $10, and a tax rate of %10 1. Order requires informational tax: Tax record is calculated and saved with a $.91 tax amount and IsInformational = true Item value = $9.09, tax amount = $.91, total invoiced value = $10 2. Order does not require informational tax: Tax record is calculated and saved with a $1 tax amount and IsInformational = false Item value = $10, tax amount = $1, total invoice value = $11 Using informational tax The IsTaxIncluded flag exists at the order line, order charge, and order line charge levels for determining how the taxes should be calculated when they are sent to the tax engine. Order Line - This field can be mapped as true or false in the create order interface. Charge Detail This field can be mapped as true or false in the create order interface. This field can be configured to populate as true or false for a particular charge type using a Charge Type Override Configure Tax Included Charge Type Override via APIPOST /order/api/order/chargeTypeOverride/save { "IsTaxIncluded": true, "ChargeTypeId": { "ChargeTypeId": "Shipping" } } Tax Rate Breakup Countries such as Canada have some unique government policies which enforces all store terminal (Point of Sale) related order captures to display tax rates by region on customer receipt. Canada has 13 regions (10 provinces and 3 territories), most of 13 provinces have different tax slabs and tax rates. This feature will allow the retailers to map tax rate coming from tax engine to each Canadian provinces. Let's take the below sample receipt to know more on the tax break up details. Sample receipt: The customer receipt sample tax section below has 2 items, one taxed for Manitoba province and other item is shipped to New Brunswick so taxed at destination province. In the above example, Manitoba is represented by MB and is taxed as GST/HST=5% and PST = 7%, where New Brunswick is represented as NB and is taxed as GST/HST = 15% (since NB has harmonized taxes, there is no PST separation in NB). To achieve the above, the tax breakup functionality does the following: All pre-requisites mentioned in the below configuration guide should be available. Taxes are grouped by tax slabs, i.e. Federal taxes are shown first for all provinces, and then we show provincial taxes. Tax identifier can be defined for each province and each tax slab within a province. In the above example, Manitoba PST has a taxId. If taxId is not defined, then we don't show that on receipts. Tax amount and Tax rate (as percentage) are shown for each province and tax slab. Quebec province taxes (QST) are unique i.e. 9.975%, all items are taxed at 0.09975 tax rate but while displaying on receipt we show as 9.980% which is a known gap. Some provinces that do not have provincial taxes but just federal taxes (such as Alberta, Yukon, Northwest territories and Nunavut), will just show GST/HST, and we will not show as short names on receipt. If any taxes are exempted, i.e. if GST/HST is 0 and/or PST is 0, then we will not show tax rates as 0 on receipt but just the tax exemption Id and reason code. The electronic Journal is modified to show tax rates by provinces. The Tax break up and mapping work with both tax engine and local taxes. For local tax configuration, refer to the local tax guide. Tax Break Up Configuration This feature can be enabled by turning on "Enable Tax Breakup" from POS General Config > Common Config. For local taxes, the tax rates need to be defined in "Advanced Tax Rate V2" and "Enable Advanced local Tax V2" should be enabled under Advanced Tax Configurations. The below configuration with tax mapping will work the same with local taxes also when defined as recommended. While this was developed primarily for Canadian tax representation on receipts, it can be used anytime a retailer wishes to show a tax rate breakdown and is using Manhattan Active® Omni Local Tax engine or Vertex. Tax Mapping on EJ and Receipts Tax Jurisdiction Mapping: Base provides seed data for all Canadian provinces, and these provinces are mapped with a short name that is represented on receipt. Users can update the short names as needed. Tax Type Mapping: Base provides seed data to map tax rate type from vertex engine with Active Omni attributes to identify tax slabs by provinces. If a retailer is using another tax engine, this can be modified based on necessity. Tax Identifier: Base does not provide any seed data for tax Id, retailer can update the tax Id across each tax slabs and provinces separately. If tax Id is not defined, then it will not be shown on the customer receipt. Electronic Journal: EJ Mod Type mapping is updated for some mod types to differentiate and label tax rates by tax slabs for each province. Field Description Suffix is used along with the existing description field to show labels for tax rates. Retailers can update this based on their needs. Receipt: All taxes are shown on customer receipts based on tax mapping. Any taxes not mapped - presumably, not related to Canada - will be collected and shown under a catch all "Other taxes" category. For example, in a cross border store, if a customer buys something in Canada and ships to the US or any other country apart from Canada, such taxes will be shown under other taxes. Any taxes with 0 tax rates will not be shown on receipt. If any or all taxes are exempted on a transaction, exempted tax slabs will not be shown on receipts. Tax Exemption The Tax Exemption feature enables the CSR to mark the orders as tax-exempt for the orders placed for charity or donation purposes. This helps to notify the external tax engine that the order is a tax-exempt order. The third-party tax engine determines the eligibility of items and orders and calculates the actual tax. See the Tax Exemption in Call Center guide for more details. Tax Exemption After Order Is Fulfilled If a customer forgets to provide their 'TaxExemptId' during order creation or modification but wishes to apply tax exemption after the order is fulfilled, the invoice tax will be recalculated, and a refund will be processed for the customer. Process Flow Eligibility for Tax Exemption After Order Is Fulfilled This section explains the criteria that should be met for applying tax exempt ID on a fulfilled order. Validation Comments A tax-exempt ID cannot be applied to a customer order if at least one unit/line is in pending return status. For example, an order with a total of $100, including $10 in taxes OL1 Total -$40 + Tax $4 OL2 Total -$60 + Tax $6 If a return is initiated for OL1, resulting in a refund, a return invoice will be created for $44. In this case, the customer order will be in 'Pending Return' status and tax exempt ID cannot be applied. Once a tax-exempt ID is applied to a customer order, it cannot be removed. Instead, CSR agents can update the existing tax exempt ID with a new ID.  In such case, A new tax-exempt ID will be updated on the order. No adjustment invoice will be created. The new tax exempt id will not be communicated to Vertex, since the previously applied id was already communicated as part of the refunding tax amount to the customer.. Order Management will not persist tax exemption if an update of the tax exempt ID results in a partial or no tax exemption. We only support updating tax exempt ID resulting in complete exemption. For example: Order Management will not retain the tax-exemption details in the following scenarios. Scenario 1: Agent entered an invalid tax-exempt id. If an invalid tax-exempt ID is applied to the parent order, then Vertex validates and returns a response with a tax amount greater than zero (no tax exemption). Scenario 2: Validation of tax exemptions is done at a jurisdictional level as tax exemption is only valid in one state, county etc. For example, if an exemption is valid in Kentucky, and the exemption ID is saved on an order with one line shipping to Kentucky and one line shipping to Tennessee, then Vertex validates and returns a response with a tax amount greater than zero (partial tax exemption). Tax Failover There are several scenarios in the order lifecycle that require evaluation or re-evaluation of quotation tax prior to an order being charged. By default, if the system is unable to retrieve tax details for the order, for example, the third-party tax engine is down, then a hold is systematically applied to the order to indicate that taxes are required. The hold type "TaxServiceNotAvailable" is provided out of the box and is automatically applied to the order in such scenarios. If the desired behavior of a tax call failure is to instead calculate the taxes from the internal Local Tax configuration and allow the order to continue processing, Local Tax can be configured as a failover gateway, and in the event of a third-party tax call failure, tax calls will be re-directed to the local tax configuration, and order tax details can be created from the local tax rates. Orders that have taxes quoted via the failover behavior will be flagged at the order level and the retailer can identify these and reconcile the taxes outside of Active Omni at a later point in time. See below for details on this behavior and key assumptions. Local Tax is the only tax gateway that can be used for tax failover, using a 3rd party gateway for failover is not supported. Failover behavior is only applicable for quotation tax calls prior to any order invoicing. The existing tax failure behavior is retained regardless of configuration if: The invoice tax call fails - the event triggering the invoicing will fail as part of the synchronous process (for example, ship event), the event can be retried at a later point in time. The order has already been partially charged - if an order has been partially charged (invoiced) using taxes from a third-party gateway, failover to local tax will not happen if the order makes an additional quotation tax call for any re-calculation. In this case, the existing behavior is retained, and the order is marked with the tax service unavailable hold type. Active Omni does not provide any tool to reconcile taxes charged via a failover strategy. Orders charged at local tax rates instead of third-party tax rates will be marked at the order level for identification purposes but must be reconciled outside the system. For order types that are configured to use the Return Order Ledger for the return tax mode and have used a tax failover strategy when charging the customer, no invoice tax call will be made for the return invoice as the refunded tax amount will be based on the tax amount from local tax on the parent order. Tax Failover Process Once a tax call has failed and the order taxes are created from local tax configuration, the order will still attempt to get tax records from the third-party gateway for any re-calculations of the quotation tax, but will honor the local tax rates on the order at the time of the 1st invoice creation. Orders stamped with local tax rates derived from the failover strategy will charge the customer these local tax rates even if the third party tax engine is available at the time of invoicing. Consider the examples below: Configuration: Tax Failover Gateway = Local Tax, Invoice Tax Mode = Invoice or Minimum Example 1: An order is created and the order configuration for the particular order type has Local Tax configured as the tax failover gateway. A quotation tax call is made, unsuccessfully, to a third-party gateway as part of the order creation or a subsequent order update. The local tax configuration is called and the configured local tax rate is applied to the order and/or line tax details. The order flag "IsQuotationTaxFailedOver" is marked as true to indicate that the quotation taxes were derived from local tax configuration. When the order is invoiced, the invoice is created using the tax details created from local tax, and the customer is charged the local tax rates. In this case, the order is treated as if the tax strategy is quotation, and a tax call is not made to the third-party tax engine. Example 2: An order is created and the order configuration for the particular order type has Local Tax configured as the tax failover gateway. A quotation tax call is made unsuccessfully to a third-party gateway as part of the order creation or a subsequent order update. The local tax configuration is called and the configured local tax rate is applied to the order and/or line tax details. The order flag "IsQuotationTaxFailedOver" is marked as true to indicate that the quotation taxes were derived from a local tax configuration. Another update is made to the order, and the third party is called again, but the call is successful. All order taxes are re-calculated by a third party and updated on the order and line tax details. The "IsQuotationTaxFailedOver" flag is updated back to false When the order is invoiced, it is treated as if no tax failover occurred, and the customer is charged based on the response from the invoice tax call. Tax Failover Configuration Tax Failover Gateway: This can be selected as Local Tax or None in the Order Configuration UI Local Tax: Local Tax rates can be configured to create tax records in a failover scenario in many different ways, but do not support the same complex tax rules that can be found in a third-party tax provider. For details on local tax rates, see the Local Tax configuration guide. Implementation Flavors How to use tax failover with the Calculate Tax user exit? Tax failover logic can be extended to implementations using the Calculate Tax user exit to integrate with a different tax provider. When the respective third party is unable to respond with a valid quotation tax response, the output of the user exit needs to set the "IsQuotationTaxFailedOver" flag as true on the order and base failover logic will request the quotation taxes from a local tax configuration instead. If the quotation tax has already failed, and the output of the user exit has already set ""IsQuotationTaxFailedOver" as true, but further updates (and quotation tax calls) against the order are required, base will still allow requests to go to the user exit, and upon successful responses from the tax gateway, the output of the user exit can re-quote the entire basket. In this case, custom logic is required to reset the "IsQuotationTaxFailedOver" flag to false, otherwise at the time of the first invoice, the base will treat this as a failover and not make an invoice tax call, instead, only charging the taxes quoted on the order. Refer to user exit documentation for Order:Order:UserExit:CalculateTax for more details. How to leverage a tax gateway to charge the Colorado delivery fee? See the Retail Delivery Fees guide for more details. How to use the tax exemption feature if a retailer is using a third party tax provider other than base integrated tax provider Vertex? Implement Order:Order:UserExit:CalculateTax UE for quotation tax calculations. Implement Order:Order:UserExit:CallInvoiceTaxService UE for invoice tax calculations. If tax exemption is applied to the non-fulfilled order, through the quotation tax call, the tax exemptions will be reported to the third-party system. If the tax exemption is being applied on the fulfilled order, through distributed tax call, tax exemptions will be reported to the third party systems. Retailers have to implement 'Order:Order:UserExit:CallDistributeTaxService' UE and send all the existing shipment invoices with negative tax amounts to third party systems. How to use multiple tax code corresponding to a single charge Multiple tax codes corresponding to a single charge are not supported out of the box. Include the extended fields at tax details to indicate the charge to which the tax is applied. This should be done before the order is imported with valid data. How to communicate differences in quotation and invoice tax to the tax provider when using minimum tax mode If your tax provider requires that the difference between quotation and invoice tax be reported to them when "minimum" tax mode is being used, a custom component is required to make this tax call to the 3rd party and report the difference. These particular tax discrepancies can be reported based on the TaxType = Adjustment, for shipment and adjustment invoices, indicating that a tax record was created internally to account for the difference in the invoice tax and what was charged to the customer. For return invoices, this will be indicated by the difference in the tax records, TaxAmount and RecordedTaxAmount. Troubleshooting Tax is being reduced on shipment invoicing This exercise should help to identify any mapping issues which could cause tax adjustments/unexpected behavior. Find the quotation tax details (tax details on the order and order lines) and the invoice tax details (tax details on the invoice and invoice lines). Compare every field from the quotation tax detail to the invoice tax detail (TaxCode + TaxTypeId + Jurisdiction + JurisdictionTypeId + FulfillmentGroupId + TaxIdentifier1). If any field does not match, then the tax details are considered not matching. If using quotation or minimum tax mode, this means that the customer may be charged less on the invoice than originally quoted, since no matching quotation tax detail was found. For example - if TaxIdentifier1 is not mapped to Vertex ImpositionType on imported e-commerce orders, then tax calculation issues could occur because the invoice tax request maps Vertex Imposition Type to TaxIdentifier1. Review the tax mapping and ensure all fields from the order capture systems such as e-commerce match the Active® Omni mapping. When importing an order with IsTaxExempt set to true, the tax on the order is not Auth reversing Along with IsTaxExempt flag, you need to send TaxExemptId on the order save. TaxExemptId is mapped to CertificateNumber and CustomerId is mapped to CustomerCode on vertex request. Why does overriding the item price increase the tax instead of reducing it? Compare the Tax and Vertex response from tran log entry for the following: Ensure that location code in AdministrativeAddress and PhysicalAddress fields are populated in both base request and vertex third part requests so that the address in both base and custom response xmls are matching. Attributes in <Taxes> array in xml response like “TaxStructure”, “JurisdictionLevel” should not be empty in custom xml response. The fields should be mapped to get proper data. Add currency tag mapping to custom vertex request and custom response xml. The taxable amount and tax amount for the appeasement do not match in some scenarios This is as designed. The taxable amount and tax amount are not related to each other and are calculated separately. On the invoice, the taxable amount is the value of the item and charges at the time of the invoice and doesn’t represent the delta of previous transactions. The tax amount is the delta of the adjustment from the previous tax amount, if any. Why is return invoice tax call made on even exchanges when PreInvoiceTaxCall user exit is implemented An invoice tax call is made for both the return and shipment invoices on the exchange order. Copying of tax and price info based on return and exchange configuration only applies to the creation of the exchange line. When the exchange line is shipped, the order’s invoice tax mode is referenced, regardless of if the shipped line is from an exchange or not. However, you will not see a tax call on shipment invoices if exchange orders are created in a new order type where the invoice tax mode is quotation. For exchange lines, if 'Reprice even exchange lines’ is set to false, there is no tax calculation, and it remains the same as the original parent order line. Tax is not recalculated correctly upon order modification when the order contains discounts Ensure that the discountOn field is mapped in the OrderLineCharges details, as tax is calculated based on the TaxableAmount using the following logic: TaxableAmount= OrderLineSubTotal- Sum of ChargeTotal where discountOn= ItemPrice/Order/OrderLine Why do I see a difference in tax charged when using the "TaxCode" tax comparison strategy? Refer to Tax Comparison Strategy for more details. To resolve this, configure the Invoice Tax Mode as "Quotation." When using a third-party tax provider, which fields are mandatory under OrderLineTaxDetail per base to be sent to Active Omni? Is it Tax Rate and Tax Type ID? The Tax Rate is mandatory, while the Tax Type ID is not mandatory. Related Articles Overview & ProrationDiscounts Currency RoundingCharges