# Invoicing and Sales Posting

**Permalink:** invoicing-sales-posting
**Path:** Manhattan Active® Omni/Order Management/Process & Configuration Guides/Order Selling/Payment/Invoicing and Sales Posting
**Content Length:** 88,602 characters
**Scraped:** 2025-08-09T21:58:48.198487

---

Home ››Manhattan Active® Omni››Order Management››Process & Configuration Guides››Order Selling››Payment ››Invoicing and Sales Posting Invoicing and Sales Posting Previous I Next This section explains invoicing, which is the process that initiates billing a customer, and sales postings, which are used to communicate inventory and financial changes to downstream ledgers and accounting systems. Invoice BasicsHow to Enable InvoicingHow Invoicing WorksInvoicing on PaidInvoice ID GenerationInvoice CalculationsProcessing Payments for InvoicesInvoice TypesShipment InvoicesAdjustment InvoicesReturn InvoicesCharge Back InvoicesInvoice CancellationSales PostingSales Posting ConfigurationPrepaid Orders (Liabilities)Reporting Payment Liabilities for Pre-Paid OrdersCalculation DetailsImplementation FlavorsSuppress Sales Posting GenerationCustom Sales PostingSales Posting for Exchange Line CancellationGuarantee Unique Invoice Identifier Generation Across OrganizationsTroubleshootingWhy is Order:Invoice:UserExit:GenerateInvoiceId user exit not getting triggered when the order is ready to be invoiced?Related Articles Invoice Basics An invoice is a document which outlines the goods or services provided and the total amount due for these goods. There are three types of invoices; shipment, return, and adjustment. Shipment invoices are created when items are fulfilled. Return invoices are created when items are returned. Adjustment invoices are created when an order is adjusted after a portion of the order has been fulfilled. Each time an invoice is created in the Order component, the payment summary is updated so that a settlement or refund can be processed. How to Enable Invoicing Invoicing is enabled for orders when payment is enabled in the Order Configuration UI. How Invoicing Works The input to the invoicing process is the quantity detail entity. To determine which quantity details are eligible for invoicing, invoicing uses a table which maps each delivery method to a fulfillment status. This is the minimum status in which quantities for this delivery method will be invoiced. For example, in the table below, when any fulfilled quantities are created for a pick-up in store line, that quantity is invoiced and settlement is initiated. In the Invoice configuration table, Ready For Tender Required controls whether the order is ready for tender, and the isReadyForTender attribute must be true before invoicing a quantity detail. The purpose of this attribute is for POS to trigger invoice creation when the customer is ready to pay. If an invoice was created before the customer adds payment, then the invoice would need to be updated for each order update, as the user adds coupons, items, and so on. The ready for tender required attribute should be set to false for all delivery methods which are not fulfilled immediately, like Pick up in store and Ship to store. Delivery Method Minimum fulfillment status in which to Invoice Ready for Tender Required Pick up in store 3600 (Picked) false Ship to store 3500 (In Progress) false Ship to address 3600 (Picked) false Ship to return center 14000 (Carrier Scanned) false E-mail 3600 (Picked) false Likewise, the ready for tender required attribute should be set to true for all delivery methods which are fulfilled immediately, like in store purchase or return as given below. Delivery Method Minimum fulfillment status in which to Invoice Ready for Tender Required Store sale 1000 (Open) true Store return 1000 (Open) true The minimum status in which to invoice can be configured based on business requirements. For example: To invoice and charge customers as product ships, configure the Ship to Address status as 'Fulfilled (7000)' To invoice and charge customers when a product is picked in the DC/stores for ship to home items, configure the Ship to Address status as 'Picked (3600)' To invoice and charge customers when a product is picked in the DC/stores for BOPIS items, configure the Pick up in store and Ship to store status as 'Picked (3600)' To invoice and charge customers when a product is moved to "In Progress" in the DC/stores for BOPIS items, configure the Ship to store status as 'In Progress (3500)' Invoice creation can also be triggered on shipment of the last merge leg for Ship to Store and Ship to Address lines (having merge leg). For Ship to Store delivery method, if Shipment of last merge leg is configured, triggering creation of shipment invoice cannot be configured for any other fulfillment statuses. For Ship to Address delivery method, if Shipment of last merge leg is configured, Picked or Packed fulfillment status cannot be selected for triggering creation of shipment invoice. Note : Invoice gets auto closed if no funds are needed to close the invoice. Hence, for an order which is fully discounted, the publish order generated at invoiced status also comes with the shipment invoice in closed and published status. If a Ship-to-Store order consists only of a pickup leg, the invoice will be generated upon fulfillment of the order line, regardless of the "invoice on last merge leg" configuration, as there is no merge leg in this case. Whenever the invoice is created at packed status, "FulfillmentInfo" should be populated in the order event payload to ensure that the "ShipFromLocationId" is populated correctly on the shipment invoice. Invoicing Examples The below example shows the invoices and sales postings created for an order shipped in multiple shipments. The below example shows the invoices and sales postings created for an Omni order, where one unit is purchased in-store and another ships to the customer's home. In the below example, a point of sale (POS) purchase is made. Invoicing on Paid Retailers can opt to generate the shipment invoices once the payment status of an order is updated to 'Paid' by enabling the configuration 'Invoice on Paid' in Order Configuration UI. With this configuration enabled, the system follows the payment life cycle rather than the fulfillment life cycle for shipment invoice generation. In addition to validating the payment status, the system checks the 'isReadyForTender' attribute before invoicing an order. Based on the business requirement, retailers should mark the order as ready for invoicing (isReadyForTender=true) once it is eligible for invoicing. Note: The “Invoice On Paid" feature can only be enabled when "Invoice Tax Mode" is set to Quotation. The 'isReadyForTender' property should be set to true through a custom extension once the order is ready for invoicing. Generation of return/adjustment invoices will follow the existing invoicing process. There will be no updates done to the closed invoice post order fulfillment. For example, PackageId will not be updated on the invoice line. Invoice ID Generation Invoice IDs are system-generated random numbers and do not follow any sequencing or logic based on order ID or order line ID. If a specific invoice ID is required, it is possible to implement the Order:invoice:UserExit:GenerateInvoiceId user exit to customize the invoice ID generation logic. This should be used if the customized invoice ID is used to drive custom logic before the sales posting is published. If that customized invoice ID is needed only in the financial reconciliation system (via sales posting), it is advised to use the "ExternalInvoiceId" field in the invoiceAdditional child entity of the invoice. This field can be populated using out of the box logic detailed below. External Invoice ID In some countries, regulations mandate each invoice have a unique ID in a specific format. This ID is generally composed of a prefix, the year and a sequential number. An "ExternalInvoiceID" attribute on the invoice can be used to generate this sequential value during the Sales Posting process. This field is populated using a next up counter. Populate External invoice Id - process flow If the external invoice ID is already populated, it should not be updated as this sequence number has already been used and assigned to that specific invoice. If an invoice is canceled before the first sales posting publication, the external invoice ID will not be populated and the next up counter not incremented for that invoice. If an invoice is canceled after it's published, it will keep the sequential ID that was associated with it. Order configuration additional Configure "Enable External Invoice ID generation" in the Order Configuration Additional UI. The menu link is managed in cmu::menuConfig profile. Order configuration Additional - External invoice ID Generate Sequential Invoice ID => boolean flag. If set to true, the application will: Start populating the Invoice.InvoiceAdditional.ExternalInvoiceID with a sequence number enable single thread processing of sales posting messages to make sure no sequence number is repeated Exclude Open Invoices for Sequential Invoice ID => boolean flag. If set to true, if the invoice is still open at the time of the sales posting, it will not get stamped with a sequence number. When the invoice is closed, if the sales posting is re-published, the external invoice ID will be updated. Invoice NextUp Config => list of configuration for each invoice type, it is possible to select a next up configuration. the same next up configuration can be used across invoice types and across order configurations Next up configuration Configure next-up number generation rules in the Next-Up Configuration UI. This configuration is associated to each of the invoice types in the Order Configuration Additional UI. The menu link is managed in cmu::menuConfig profile. Next up number - External invoice IDEach Next up configuration is composed of: A counter ID => unique ID of the next up config. Will be used in the order configuration additional menu The length of the value returned by this next up configuration A prefix => prefix that will be added to the next up number The start and end value of the sequence The current value of the sequence The possibility to add the date to the next up number and its format. The increment of the number (should be set to 1 for the purpose of the External invoice ID) The next up configuration is protected by the omui::* resource. Make sure it is added to the users role before trying to configure a next up configuration. Message types and seed data All message related seed data should exist in the active profile. If the seed data copy failed, all message types are documented below. External invoice ID - messages seed dataInbound message type in order component (ord::messaging active profile): { "MessageType": "GenerateSeqInvoiceIdMSGType", "NoOfConsumer": 10, "MinNoOfConsumer": 1, "Idempotent": true, "ExternalIntegrationRequired": false, "MaxDesiredInstances": 6, "ScaleUpTimeWindow": 10, "ScaleDownTimeWindow": 20, "Description": "This queue is used to generate sequential invoice id", "ServiceId": "sequentialInvoiceIdGeneration" } Outbound message type in order component (ord::messaging active profile): { "MessageType": "GenerateSeqInvoiceIdMSGType", "Transactional": true, "PersistMessageToMsgStore": false } Extension point in order component (system profile) { "ComponentId": "Order", "ExtensionPointId": "Order:Order:Event:GenerateSeqInvoiceIdMSGType" } ExtPoint to message type in order component (ord::processDefinition active profile): { "ExtensionPointId": "Order:Order:Event:GenerateSeqInvoiceIdMSGType", "MessageType": "GenerateSeqInvoiceIdMSGType" } If using a custom sales posting publishing template, add the InvoiceAdditional child table and the field InvoiceAdditional.ExternalInvoiceId. Example of a sales posting template with ExternalInvoiceIDTo publish the external invoice ID, the sales posting templates need to contain the below: { //... rest of the template "Invoice": { "InvoiceId": null, "InvoiceAdditional: { "ExternalInvoiceId": null } /... rest of the invoice template } //... rest of the template } Extensibility Population of the ExternalInvoiceId field using custom code is possible. Use user exit Order:Invoice:UserExit:GenerateExternalInvoiceID to bypass the base process and generate the external invoice Id using custom code. Performances If the population of the external invoice ID is enabled, to guarantee the sequencing and uniqueness of the external invoice ID, the sales posting publishing process has to become single threaded. Compared to the multithreaded process if there is no external invoice ID population, we observed a performance degradation of 30% in time it took to publish all the invoices for 30k and 50k sales posting: Scenario No. of orders Time taken (Observed in Sales posting outbound) Sales posting generation time with sequential invoice ID 30k 21 Minutes Baseline - multithreaded process 30k 17 minutes Sales posting generation time with sequential invoice ID 50k 100 minutes Baseline - multithreaded process 50k 77 minutes Invoice Calculations To calculate the value of each invoice, the Get Order Value API is used. This API takes an input list of items and quantities. The output contains lines with line totals, taxes, charges, and discounts prorated for the input quantity. If any of the order line is exempted from charges, then during invoice charge calculation, the charges will be exempted on the order line. Refer here for more details. This API can also be used to calculate the value of any subset of items on an order. For example, if a fulfillment system needs to get the value of items within a package to print a packing slip, then this API can be used to retrieve the total price, taxes, discounts, and charges for the items within a given package. Processing Payments for Invoices Each time an invoice is created, the Order component generates a payment request to notify the Payment component. The Payment component updates the payment summary and creates any necessary authorization, settlement, and refund transactions. The transactions are immediately executed if real-time payment processing is configured, or they are executed on the next scheduled run if real-time payments are not enabled. Each time a payment transaction is updated with a success decision, the Payment component updates the amount processed on the corresponding invoice. Each time a payment transaction is updated with a failure decision, the Payment component updates the failed amount on the corresponding invoice. When amount processed is equal to invoice total, then the invoice status is updated to closed. Once an invoice is closed, it should never be re-opened. If an adjustment is needed on a closed invoice, an adjustment invoice will be created by the system. Invoice Types There are four types of invoices; Shipment, Return, and Adjustment. Shipment Invoices Shipment invoices are used to charge a customer when items are fulfilled. For in store purchases, a shipment invoice is created at the time a customer provides payment. An invoice is required for in store purchases in order to determine the total amount to settle and total amount to authorize, since funds should be settled immediately for in store purchases and authorized for items that are yet to ship. For order lines with delivery method ship to address, a shipment invoice is created when a shipment notification is received. For pick up in store or ship to store lines, a shipment invoice is created when a pick-up notification is received, indicating that the customer has picked up the items. Shipment invoices are created only for order lines where isReturn is false. One shipment invoice is created per package fulfilled. There is no package entity maintained for an order; instead there is a fulfillment Detail entity which represents an item in a package. To identify packages for invoicing, fulfillment details are grouped using the package ID. The fulfillment detail is used only for grouping quantities into invoices; the quantity invoiced is determined using the quantity detail entity. For example: If two fulfillment details are created for an order line, one with packageId 001 and one with packageId 002, then two invoices are created. If one fulfillment detail is created for each of two order lines, both with packageId 001, then one invoice is created. Adjustment Invoices Adjustment invoices are created in two scenarios. One where an order is at least partially fulfilled, and an update occurs to the order which requires an adjustment to the customer's balance due. For instance, if an appeasement is applied to a shipped order, then an adjustment invoice is created to refund the customer for the value of the appeasement. Secondly, if a shipment invoice is existing for the order and quantities are canceled resulting in a refund scenario. For example, if shipment invoice is created when quantities are shipped for last merge leg for Ship to Store lines, and if some quantities are found to be damaged while receiving them at the store, the store sends short order event for cancellation of those quantities. An adjustment invoice is created only in case of changes in unit price, line charge detail and header charge detail. Tax (header or line) changes will not create any adjustment invoice, but will update the order total, leading to additional capture or refund if necessary. The following diagram explains the logic used to create adjustment invoices. Adjustment Invoice Examples for Appeasement Example 1: If a shipped paid order with a $60 order line and a $40 order line has a -$10 appeasement applied at the header level, then the appeasement is prorated across the order lines Order Header Appeasement: -$10 Order Lines Line 1: $60 subtotal Prorated Appeasement: -$6 Line 2: $40 subtotal Prorated Appeasement: -$4 Because the expected invoiced amount is now $90, but $100 has been invoiced, an adjustment invoice is created for -$10. The adjustment invoice contains both order lines, since the appeasement on each line has not yet been invoiced: Invoice Header Appeasement: -$10 Order Lines Line 1: $0 subtotal - quantity = 0 Prorated Appeasement: -$6 Line 2: $0 subtotal - quantity = 0 Prorated Appeasement: -$4 Example 2: A partially shipped order with a 2-unit order line has a -$10 appeasement applied at the line level: Order Header Appeasement: -$10 Order Lines Line 1: $100 subtotal ($50 unit price, quantity = 2) Prorated Appeasement: -$10 Shipped Quantity = 1, Back Ordered Quantity = 1 Because the expected invoiced amount is now $45, but $50 has been invoiced, an adjustment invoice is created for -$5. The adjustment invoice contains the order line and a -$5 appeasement: Invoice Header Appeasement: -$5 Order Lines Line 1: $0 subtotal - quantity = 0 Prorated Appeasement: -$5 When the remaining unit ships, the shipment invoice takes the remaining -$5 appeasement into account to create an invoice for $45. If partial quantities of the order line is canceled due to DC/Store Short message and the remaining quantities are fulfilled, a Adjustment Invoice is created to reflect the canceled quantities charges etc.. Given below is an example of Shipment Invoice created when store associate picked the order and Adjustment Invoice created when customer rejected some items for Pickup at Store order line, for create Invoice On configured to fulfillment status "Picked" Given below is an example of Shipment Invoice and Adjustment Invoice created for Ship to Store order line for create Invoice On configured to Shipment of last merge leg: Return Invoices Return invoices are used to refund a customer when items are returned. When an item is returned in store, a return invoice is created at the time of payment. When an item is shipped to a return center, a return invoice can be configured to be generated when the return labels are carrier scanned or it can be created after the items have been received and verified. Return invoices are created only for order lines where isReturn is true. If a return order contains items from multiple parent orders, then one return invoice is created per parent order. One return invoice is created for any blind return items, for which no parent order exists. For example, if a customer purchased an item on Monday and an item on Wednesday and returns both items in a single transaction, then two return invoices are created. The below table lists return invoicing requirements and denotes which requirements are supported. Business Requirement Order Line Delivery Method Status in which to Invoice Supported Out of the Box Refund the customer while they are standing at the cash wrap Store return 11000.000 (Open) + Ready for Tender + return order does not need to be confirmed (isConfirmed=false) Yes Refund for return items as they are received and verified fully for all the units - for all the return lines of the return order Ship to return center 18000.000 (Returned) Yes; This protects retailers in case the return items are never received Refund for return items as and when they are received and verified - for all the units for each return line of the return order Ship to return center 18000.000 (Returned) Yes. This allows the retailers to refund the customer as and when all the units for a single return line is received and verified instead of waiting for all the units of all the return lines are received and verified completely. Refund for return items as they are received and verified - for partial units of the return lines Ship to return center 18000.000 (Returned) No Currently, we do not support return invoice generation for partial units received and verified since it complicates the process of verifying return variances and proration of charges. Refund the customer on return order confirmation Ship to return center 11000.000 (Pending Return) + Confirmation No; we cannot support this until we have a way to charge the customer if return items are not received in the expected quantity, condition, and so on. Refund the customer when the carrier scans the return package Ship to return center 14000.000 (Carrier Scanned) Yes. This allows the retailers to refund the customer as and when the return label is scanned by the carrier. Full quantity of all the return lines with receipt expected true will be invoiced. Refund the customer after X days, in case the warehouse does not verify ASNs Ship to return center 11000.000 (Pending Return) + X days (milestone config) No; we cannot support this until we have a way to charge the customer if return items are not received in the expected quantity, condition, and so on. Charge Back Invoices Chargeback invoices are created as a result of the return verification process when a refund is issued during the carrier scan process before any item receipt has taken place. Because the full amount of the return is refunded when an order is considered to have been 'carrier scanned', the chargeback invoice functions to track what units of inventory were refunded and not returned, so the customer can be charged the appropriate amount, either the full or partial amount of the refund. The chargeback invoice is created after the return order verification event has been processed and any corresponding order line hold(s) has been removed. Depending on the final total of the return, including exchanged or additional sale items present on the return order, the chargeback invoice may initiate a chargeback settlement to charge the customer the amount that was refunded but not returned during item verification. Chargeback is only possible against payment methods that are configured as eligible for chargeback. This can be done in the Payment Configuration UI for each payment type that can support chargeback. For example, if a return order has a return line with isReturnExpected = true with 10 qty and invoicing on carrier scanned status is enabled, the return invoice is generated for 10 qty when the return line moves to carrier scanned status. Later, when the package is received and verified in the return DC, if only 8 qty is received and verified, a charge back invoice is created for the 2 qty for which a refund was issued in excess by prorating the dollar amount from the return invoice created earlier. As soon as a charge back invoice is generated, a stand alone payment settlement is executed for the payment method on the parent customer order associated to the payment type configured for charge back (eligibleForChargeBack = true). Once the payment settlement is successfully processed by the payment gateway, it will be mapped to the charge back invoice and the invoice will be closed. This settlement will then be copied to the parent customer in order to make the funds available for further returns. If a payment type is configured for a charge back, the entire amount will be refunded on carrier scan to the configured payment type and does not have any impact on refund on return invoice(irrespective of whether the refund is on carrier scan or verification). For example, if a payment of gift card is configured to refund on verification and a payment of credit card is configured to refund on carrier scan, and if an order is paid with a $40 gift card and $60 credit card; on creating refund for $100, the entire $100 gets refunded at the time of carrier scan itself depending on the payment type configured and the refund does not get split between carrier scan and verification. In the case of charge back, when a charge back invoice is created, the payment method configured for charge back will be over charged for $100 irrespective of the refund amount issued during carrier scan. Similar to basic return and refund flows, the payment amounts are moved between the return order and the parent order via copied settlement and return credit payment transactions. Consider the following examples: Chargeback Scenario 1: Return Chargeback At T1, the return order is carrier scanned, and the full amount refunded At T2, the return verification takes place, indicating that no items were returned Parent Order Order Line SKU Quantity Line Total 1 Item A 2 $40 2 Item B 2 $60 Return Order Order Line SKU Quantity Line Total 1 Item A 2 ($40) Invoices Time Invoice # Invoice Type Amount Description T1 Invoice A Return ($40) Full return amount issued on carrier scan T2 Invoice B Chargeback $40 Full amount charged back when 0 items were returned Payment Time Payment Method Payment Transaction Amount Description T1 Credit Card A Settlement A (Copied) $40 Settlement copied from the parent to cover the full amount of the return T1 Credit Card A Refund ($40) Refund issued during carrier scan for the full amount of the returned items T2 Credit Card A Settlement B $40 Chargeback settlement created when 0 items were returned Parent Payment Time Payment Method Payment Transaction Amount Description T0 Credit Card A Settlement A $100 Original shipment settlement T1 Credit Card A Return Credit $40 Return credit created to move $40 of eligible refund amount to the return T2 Credit Card A Settlement B (Copied) $40 Chargeback settlement copied to the parent order to indicate that $40 is again eligible for refund Chargeback Scenario 2: Even Exchange Chargeback At T1, the return order is carrier scanned to release the exchange line hold, as this is an even exchange, nothing is refunded At T2, the return verification takes place, indicating that no items were returned Original Order Order Line SKU Quantity Line Total 1 Item A 2 $40 2 Item B 2 $60 Exchange Order Order Line SKU Quantity Line Total 1 Item A 2 ($40) 2 Item A 2 $40 Invoices Time Invoice # Invoice Type Amount Description T1 Invoice A Return ($40) Invoiced amount for tracking, not refunded T2 Invoice B Chargeback $40 Invoiced amount for tracking, not charged back Payment Time Payment Method Payment Transaction Amount Description T1 Credit Card A Settlement A (Copied) $40 Settlement copied from the parent to move funds to the return T2 Credit Card A Return Credit $40 Return credit added to move funds back to the parent order T3 Credit Card B Authorization $40 Additional payment to be added in customer service or pay by link Original Order Payment Time Payment Method Payment Transaction Amount Description T0 Credit Card A Settlement A $100 Original shipment settlement T1 Credit Card A Return Credit $40 Return credit created to move $40 of eligible refund amount to the return T2 Credit Card A Return Credit ($40) Chargeback settlement copied to the parent order to indicate that $40 is again eligible for refund Chargeback Scenario 3: Positive Exchange Chargeback At T1, the return order is carrier scanned to release the exchange line hold, as this is a positive value exchange, nothing is refunded At T2, the return verification takes place, indicating that no items were returned Original Order Order Line SKU Quantity Line Total 1 Item A 2 $40 2 Item B 2 $60 Exchange Order Order Line SKU Quantity Line Total 1 Item A 2 ($40) 2 Item B 2 $60 Invoices Time Invoice # Invoice Type Amount Description T1 Invoice A Return ($40) Invoiced amount for tracking, not refunded T2 Invoice B Chargeback $40 Invoiced amount for tracking, not charged back Payment Time Payment Method Payment Transaction Amount Description T0 Credit Card B Authorization $20 Added during exchange creation to cover the additional amount T1 Credit Card A Settlement A (Copied) $40 Settlement copied from the parent to move funds to the return T2 Credit Card A Return Credit $40 Return credit added to move funds back to the parent order T3 Credit Card C Authorization $40 Additional payment to be added in customer service or pay by link Original Order Payment Time Payment Method Payment Transaction Amount Description T0 Credit Card A Settlement A $100 Original shipment settlement T1 Credit Card A Return Credit $40 Return credit created to move $40 of eligible refund amount to the return T2 Credit Card A Return Credit ($40) Chargeback settlement copied to the parent order to indicate that $40 is again eligible for refund Chargeback Scenario 4: Negative Exchange Chargeback At T1, the return order is carrier scanned to release the sale/exchange line(s) hold and refund the difference in value between the returned item(s) and sale/exchange item(s) At T2, the return verification takes place, indicating that no items were returned Original Order Order Line SKU Quantity Line Total 1 Item A 2 $40 2 Item B 2 $60 Exchange Order Order Line SKU Quantity Line Total 1 Item B 2 ($60) 2 Item A 2 $40 Invoices Time Invoice # Invoice Type Amount Description T1 Invoice A Return ($60) Invoiced amount during carrier scan, partially refunded T2 Invoice B Chargeback $60 Invoiced amount during return verification, partially charged back Payment Time Payment Method Payment Transaction Amount Description T1 Credit Card A Settlement A (Copied) $20 Settlement copied from the parent to move amount for refund T1 Credit Card A Settlement A (Copied) $40 Settlement copied from the parent to move funds eligible for refund T1 Credit Card A Refund $20 Refund issued during carrier scan for the partial amount of the returned item(s) T2 Credit Card A Return Credit $60 Return credit added to move funds back to the parent order T2 Credit Card A Settlement B $20 Chargeback settlement created when insufficient items were returned T3 Credit Card B Authorization $60 Additional payment to be added in customer service or pay by link Original Order Payment Time Payment Method Payment Transaction Amount Description T0 Credit Card A Settlement A $100 Original shipment settlement T1 Credit Card A Return Credit $20 Return credit created to move refund amount to the return T1 Credit Card A Return Credit $40 Return credit created to move eligible refund amount to the return T2 Credit Card A Return Credit ($40) Chargeback settlement copied to the parent order to indicate that  is again eligible for refund T2 Credit Card A Settlement B (Copied) $20 Chargeback settlement copied to the parent order to indicate that amount is again eligible for refund Invoice Cancellation In rare scenarios, invoices can be canceled. The first such scenario is when an order is post voided, which occurs when the order attribute IsPostVoided is updated to true and the Payment Header attribute IsCancelled is updated to true. When an order is post voided, all payments on the order are voided, so the corresponding invoices are also canceled. This includes shipment, adjustment, and return invoices. For example, if a customer purchases a $40 item and pays using credit card, and later post voids the order: $40 item added to the cart in POS > Order created with ReadyForTender = false User proceeds to payment in POS > Order updated with ReadyForTender = true > Shipment invoice created for $40 User swipes a credit card payment for $40, prints a receipt, and completes the transaction Later, the user post voids the order in POS > Order updated with IsPostVoided = true > Shipment invoice canceled Payment header updated with IsCancelled = true > credit card settlement is voided Another scenario in which an invoice can be canceled is when a user has proceeded to payment in POS, but needs to navigate backwards to modify the order. When a user navigates to the payment screen in POS, the order ReadyForTender attribute is updated to true, which triggers invoice creation. However, if the user needs to navigate backwards to make order edits such as adding a coupon, removing items, or adding a tax exemption, then these order edits could affect the invoice totals, so the invoice needs to be recalculated. Therefore, when a user navigates backwards from the payment screen in POS, the ReadyForTender attribute is updated from true to false, which cancels any existing invoices. This includes shipment, adjustment, and return invoices. For example, if a customer purchases a $40 item but forgot to apply their coupon: $40 item added to the cart in POS > Order created with ReadyForTender = false User proceeds to payment in POS > Order updated with ReadyForTender = true > Shipment invoice #1 created for $40 Customer wants to add a coupon, so the user navigates backwards from payment to modify the order > Order created with ReadyForTender = false > Shipment invoice #1 canceled Customer adds a $10 coupon > Order total becomes $30 User proceeds to payment in POS > Order updated with ReadyForTender = true > Shipment invoice #2 created for $30 Customer provides $30 payment and the transaction is completed If a user has added payment in POS and then needs to modify the order, then the POS system must ensure that all payments are voided before permitting a user to navigate backwards. When an invoice is canceled, the order PublishStatus is updated to 'Ready for Publishing,' which ensures that a Sales Posting will be published with the canceled invoice. Sales Posting The sales posting is an outbound message which gets published to downstream financial systems for customer orders. The sales posting message includes the order, invoices, payment, and returns. The retailer uses invoices to record movement of inventory out of their network and to record the details of payment transactions - both those that succeeded and those that failed - in their accounts receivables and general ledger records. The Sales Posting outbound message can be further customized to include only a sub set of payment attributes by creating a custom response template in the payment component with the same TemplateId saved on the order component for the sales posting. For example, if the Sales Posting Template selected in the order configuration has "TemplateId": "ElectronicJournalTemplate"; create and save a custom template in the payment component as well, with "TemplateId": "ElectronicJournalTemplate". The API - POST {{url}}/payment/api/fwcore/responseTemplate/save - can be used to save the template in the payment component. The base does not have any recommendation / seed template for payment attributes that need to be included in Sales Posting. The project team has to identify them as per the customer requirements, since each customer/implementation/template/project has different requirements. This template will also be applied to Related Orders sections if included in the Sales Posting template. Here is one test template that you can use for your reference - just make sure that the TemplateId in Order component for SalesPosting is the same as the TemplateId in Payment component: { "BaseEntity": "PaymentHeader", "OrgId": null, "TemplateJson": { "OrderId": null, "PaymentGroupId": null }, "TemplateId": "ElectronicJournalTemplate" } Sales postings can be published in one of two formats with only net new invoices, or with all invoices. Each invoice has a publish status which is used to track whether the invoice has been included in a sales posting. Invoices are created with publish status "Draft." When an invoice is updated after a payment succeeds or fails, or when a zero dollar invoice is created, then the invoice publish status is updated to "Ready For Publishing." When an invoice is updated to "Ready for Publishing" status, the parent order's publish status is also updated to "Ready for Publishing." If only net new invoices are included in the sales posting, then only invoices with status "Ready For Publishing" are included. Otherwise, all invoices are included in the sales posting.  After a sales posting is published, the order and any invoices which have publish status "Ready for Publishing" are updated to status "Published." Any invoices which are included in the sales posting in "Draft" status are not updated. If the invoice requires an "ExternalInvoiceID" to be populated (see External invoice ID documentation) an additional status is used during the sales posting process: "Awaiting Sequential Invoice Id". This status will be used before the "ready for publishing" status. Sales postings can be published in real-time, as payments occur, or in batch at the end of each business day. If batch mode is enabled, then a scheduler picks all orders with publish status "Ready for Publishing" and publishes a sales posting. If real-time mode is enabled, then a sales posting is published each time an order is updated with "Ready for Publishing" status. Sales posting job query CANNOT be parametrized in case there is a requirement, for example, excluding any order from being published as part of sales posting. For example - for publishing order's with Order.publishStatusId='Ready For Publishing' - the job query cannot be modified to look like - SELECT * FROM Order where Order.publishStatusId='Ready For Publishing' When a sales posting is published for an order which has returns or exchanges, the list of return orders is included in the Related Orders section. An order is included in the related orders section if it contains any return or exchange line which references the parent order. The return order may also contain return or exchange lines which reference a different parent order. For example, order A is completed, and a customer returns the item from order A on a new order B. However, in order B, the customer also returns an item from order C. Because order B has return lines from both order A and order C, order B is included in the sales postings for order A and order C. When a sales posting is published for a return or exchange order, the list of parent orders is included in the Related Orders section. An order is included in this section if it is referenced as a parent order of any order line. For example, a customer places order A to return items from order B and order C. When a sales posting for order A is published, it contains orders B and C. Note: When a return is canceled, the parent order information is not included in the Related Orders section. When an order is post voided, there will be three salesposting messages generated. The first one is when the invoice is generated (Order update for shipment invoice generation), the second one is when the invoice gets cancelled (Order update with the Post Void listed), and the third message is when the payment is reversed and the invoice amount is updated to zero (Order update with the invoice payments zeroed out). One can re-publish the sales posting using this API - Get - {{url}}/order/api/order/order/publishSalesPosting/orderId/{OrderId} Sales Posting Configuration The Sales Posting message can be published in two modes as a scheduled batch job or throughout the day, as each payment is processed. If the order configuration attribute Sales Posting Mode is set to Real Time, the system publishes Sales Posting messages in real time, as each settlement or refund is processed. Sales Postings are published when order publish status is updated to Ready for Publishing. This is intended for sales audit systems which can receive sales postings throughout the business day, as each transaction is processed. If Sales Posting Mode is set to Scheduled, the system Publishes Sales Posting messages based on the configured schedule. When the scheduler runs, Sales Postings are published for orders which have publish status equal to Ready for Publishing. This is intended for sales audit systems which need to receive transactions on a schedule (for example, at the close of each business day). The Sales Posting message can be configured to include or exclude specific attributes and entities by using a template. Select a template to use for the Sales Posting messages by configuring the Sales Posting Template setting in the Order Configuration UI. The Sales Posting message can include all invoices or only net new invoices. If Include All Invoices is set to true, the Sales Posting includes all invoices. This setting is recommended for sales audit systems which can use the publish status attribute to determine which invoices are new. If set to false, the Sales Posting includes only net new invoices, which are identified by a publish status equal to ReadyForPublishing. The outbound Sales Posting message can be published in multiple formats. Select a sales posting template by navigating to the Sales Posting section of the Order Configuration UI. Template Name Description Order with original charges, discounts, and taxes This format includes header and line-level charges, discounts, and taxes in the format in which they were originally created. Charges, discounts, and taxes which were created as a result of proration are excluded. When an order-level charge, discount, or tax is created, OM prorates this charge across order lines for processing. Designed for downstream systems which accept taxes, charges, and discounts at the header and line level. For example, if an order is created with a $10 order-level S&H charge, $1 order-level S&H tax, and a $100 order line with a $5 line-level sales tax, then the Order component prorates the S&H charge to line level, creating a $10 S&H charge and $1 S&H tax on the line. The outbound message includes the order with the $10 order-level S&H charge, $1 order-level S&H tax, $100 order line, and $5 line-level sales tax. Order with only line-level charges, discounts, and taxes This format includes only line-level charges, discounts, and taxes for the order and invoices, including line-level entities created as a result of proration. When an order-level charge, discount, or tax is created, OM prorates this charge across order lines for processing. Designed for downstream systems which accept only line-level taxes, charges, and discounts. For example, if an order is created with a $10 order-level S&H charge, $1 order-level S&H tax, and a $100 order line with a $5 line-level sales tax, then the Order component prorates the S&H charge to line level, creating a $10 S&H charge and $1 S&H tax on the line. The outbound message includes the order with the $100 order line, $5 line-level sales tax, and the prorated $10 S&H charge and $1 S&H tax on the line. Order with all charges, discounts, and taxes This format includes all header and line-level charges, discounts, and taxes for the order and invoices. When an order-level charge, discount, or tax is created, OM prorates this charge across order lines for processing. In this format, the outbound message includes all charges, discounts, and taxes, including order-level, line-level, and line-level entities created as a result of proration. Designed for downstream systems which can read taxes, charges, and discounts at the header and line level. For example, if an order is created with a $10 order-level S&H charge, $1 order-level S&H tax, and a $100 order line with a $5 line-level sales tax, then the Order component prorates the S&H charge to line level, creating a $10 S&H charge and $1 S&H tax on the line. The outbound message includes the order with the $10 order-level S&H charge, $1 order-level S&H tax, $100 order line, $5 line-level sales tax, and the prorated $10 S&H charge and $1 S&H tax on the line. Prepaid Orders (Liabilities) Reporting Payment Liabilities for Pre-Paid Orders On pre-paid orders, a payment has been settled before items are fulfilled. When updates occur to these orders resulting in a refund, retailers may need to receive an outbound message to update sales audit. For example, a two-line, pre-paid order has a $60 item released for fulfillment and a $40 back ordered item. If the $40 item is canceled, then an outbound Publish Order message can be published with the $40 refund transaction. The order header attribute Liability Amount is used to trigger these outbound messages. The Liability Amount is the amount owed to the customer. Liability Amount is the sum of settlements without invoices. It is calculated as the sum of settlement transactions minus refund transactions minus the sum of invoices. The below examples could trigger an outbound message due to a change in Liability Amount: Cancellation of quantities or lines on a pre-paid order -- short or customer cancellation. Settlement succeeds on an order which is not yet fulfilled (a pre-paid tender is added) Appeasement applied to an authorized order Uneven exchange created for less than original purchase. Calculation Details Liability Amount = Credit - Debit (-returned in case of XO/RO) Credit = Sum of settlement transactions - sum of refund transactions* Debit = Sum of invoices *Open settlements/refunds are not considered in the calculation *Negative Values are rounded to 0 Changes to the Liability Amount are include on the change log of the outbound message – Order::LiabilityAmount::Update. Retailers will have to use a Get Order call to view new values. 1"ChangeLog":{"ModTypes":{ 2"Order":["Order::LiabilityAmount::Update"] 3}} Calculating the Liability Amount for each order is automatically enabled. To enable the outbound Publish Order message when the Liability Amount changes: Navigate to the Order Configuration UI Sync the current environment to include new order configuration options. Post: {{url}}/order/api/order/orderConfig/sync Use an empty body in the post. Find the Liability Amount mod type – “Update Liability Amount” Enable the Publish Order service for this mod type Implementation Flavors Suppress Sales Posting Generation Create a new order config, and orderType for the orders and disable the Publish Sales posting in the order config. Custom Sales Posting Publishing sales posting message when exchange line is canceled When exchange lines are cancelled, a refund transaction is triggered but an adjustment invoice is not created. To generate a sales posting message in this scenario, custom UE Order:Order:UserExit:CustomExtensionService1 *to *Order:Order:UserExit:CustomExtensionService20 can be used on OrderLineCancel modtype to update the PublishStatus back to "Ready for Publishing", which will generate the sales posting again. Publishing sales posting message on invoice creation to track Inventory adjustment in downstream system Update the publish status on the invoice to “READY FOR PUBLISHING” which will trigger sales posting. Attributes can be updated using the save order api. Adding customized, calculated values to the sales posting Add an extended attribute to your entity of choice, (invoice, invoice line, eInvoice, eInvoice line, etc.) Create a custom listener on your sales posting queue that publishes to the downstream financial system Modify the attributes on the sales posting based on the calculations done by the custom listener Publish to the downstream financial system post-update Publish an event to the order save queue to track the calculated values on the order Sales Posting for Exchange Line Cancellation Sales posting gets generated only on Invoice creation. The system generates invoices either when we ship or when we receive items from customers. When you cancel a sale line, the customer neither receives the item nor gets refunded. Hence, no invoice will be generated, and no sales posting is expected. Guarantee Unique Invoice Identifier Generation Across Organizations Map your invoice identifier downstream to the external invoice Id instead of the invoice Id. Create NextUp configuration for the desired invoice type Set BU Specific Counter = false Set Counter Scope = ORG Troubleshooting Why is Order:Invoice:UserExit:GenerateInvoiceId user exit not getting triggered when the order is ready to be invoiced? Make sure you have the next-up configuration setup in the environment. Related Articles Payment TypesCapturing PaymentFraudRest APIs and User ExitsRefundseInvoice Payment OverviewOther Transaction TypesPayment Health DashboardTesting & Troubleshooting PaymentPayment FailuresSettlementAuthorizationPayment Schedulers & Batch ProcessingPayment Gateway IntegrationHow Payment Processing Works