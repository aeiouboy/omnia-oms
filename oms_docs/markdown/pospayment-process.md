# POS Payment Process

**Permalink:** pospayment-process
**Path:** Manhattan Active® Omni/Store/Process & Configuration Guides/Point of Sale/POS Classic Guides/POS Order Selling/POS Payment/POS Payment Process
**Content Length:** 71,672 characters
**Scraped:** 2025-08-09T22:02:50.750375

---

Home ››Manhattan Active® Omni››Store››Process & Configuration Guides››Point of Sale››POS Classic Guides››POS Order Selling››POS Payment ››POS Payment Process Payment Process Payment ProcessCapturing PaymentPayment Captured at the Point of Sale (POS)Balance DueForeign (or alternate) CurrencyEMV dataDepositsCustom Tender CreationCustom Payment TypesPrivate Label Credit CardConfiguring a Single Card Option for Both Credit and Debit PaymentsPayment Capture ConfigurationUser Input FormsTender FrankingSharing Payment Terminals between Mobile Registers - Delay Payment Terminal SessionExchange Tender (ET) TransactionsET Workflow diagramET - Associating a customerET - Charging the tender to be exchangedET - Payback processET - Receipt and ReprintGift card Cash outPayment Hardening and Failure HandlingRequestLogs/UniqueIdHardening workflowHandling Communication errorPrior to Release 23.1- Legacy Comm failure handling Following Release 23.1- Flexible Comm failure handlingPayment ReconciliationWork Flow of payment reconciliationReconciliation Process OutlineRefresh PaymentServices The Payment component processes payments for orders initiating in any channel, including e-commerce, point of sale (POS), or call center. During the life cycle of each order, the Payment component manages order authorizations, settlements, and refunds through integration with payment gateways such as CyberSource, PayPal, or PAYware Connect. If a payment is captured and authorized in the order capture system such as POS or e-commerce, then the Payment component performs follow-on re-authorizations, settlements and refunds against the initial authorization. The Payment component uses order data to determines the type of transactions that are required. Settlements are created for the value of the fulfilled items, and authorizations are created for those that are ordered but not yet shipped or picked up. For example, when an in-store purchase is made using a credit card, the Payment component attempts to settle for the value of the order. When an online order is placed using a credit card, the Payment component attempts to authorize for the value of the order and will settle the value when the order ships. Each order can be paid with an unlimited number of payment methods. Supported payment types include cash, check, credit card, debit card, e-check, gift card, PayPal, store credit, and Travelers' check. Additional payment types can be configured as required. Capturing Payment Payment Captured at the Point of Sale (POS) When orders are captured in store, POS processes payments and saves completed payment transactions in the Payment component. Since the terminal or mobile sled used to capture payments typically integrates directly with payment gateways, POS does not use the Payment component to calculate or execute services to create and execute transactions. Instead, POS uses the Total Payment Summary API to get the total amount to authorize, settle, or refund, and then POS creates payment transactions and calls the gateway to execute them. If Gift card is used to pay for an omni sale (Order having in-store and ship to address lines), the user will be asked to swipe the GC twice even though both will be settlement records. Balance Due When a UI needs to display the balance due so that a store associate or customer care representative can collect payment, then the Order component calculates the balance due by calling the Payment component. The Get Order API includes a balance due attribute in the response. To calculate the balance due, the Order component calls the Get Payment Header API to get all the payment methods from the Payment component. Then, the Order component calculates the balance due as \(Balance Due = Order Total - \sum (Amount - Current Refund Amount, \forall Payment Methods)\) Foreign (or alternate) Currency POS allows retailers to accept foreign currency as a form of cash payment.  There are multiple configurations to set this up (see POS Payment Configuration guide for more details) When configured, the user will see an additional dropdown on the Order Summary > Cash tab.  By default, the stores base currency will be selected.  Should the customer wish to pay in an alternate currency, the user can tap on the dropdown and a list of allowed currencies will be displayed. Upon selection of an alternate currency: The user will see two additional details on the screen: The converted balance will show under the base currency balance due This allows the user to easily tell the customer how much to pay in the alternate currency. The converted amount under the Enter Amount field This allows the user to see the conversion as it is being typed into the Enter Amount field. Users can accept multiple currencies, or combine an alternate currency with a different payment method. Note: If an overtender occurs and there is a change due to the customer, the change due will display in the store's base currency.  Currently, POS does not allow for change to be returned via alternate currency. EMV data The term EMV stands for Europay, MasterCard and Visa. EMV is a global standard for authenticating credit and debit card transactions with integrated circuit cards, or “chip cards” at capable point of sale (POS) terminals. Manhattan Active® Omni POS Receipts will be able to capture EMV data. EMV data should be divided into 2 parts i.e. EMV header and EMV secondary details. EMV data is configurable, retailers need to enable business flags to "Receipt Inc Emv Primary" and/or "Receipt Inc Emv Secondary" on receipt parameters to have this printed on the base POS receipts. If a transaction is made via chip card, all receipts must include the following EMV information in addition to standard receipt information. EMV Primary receipt data and related mapping to the metadata entity attributes. Link for sample receipt. EMV Primary Mapping Card Holder Verification Method PaymentTransactionEMVTags.EMV_CVM Transaction Sequence Counter PaymentTransactionEMVTags.EMV_TAG_9F41 Application Label PaymentTransactionEMVTags.EMV_TAG_50 AID (Application Identifier) PaymentTransactionEMVTags.EMV_TAG_4F TVR (Terminal Verification Results) PaymentTransactionEMVTags.EMV_TAG_95 IAD (Issuer Application Data) PaymentTransactionEMVTags.EMV_TAG_9F10 TSI (Transaction Status Indicator) PaymentTransactionEMVTags.EMV_TAG_9B ARC (Application Response Code) PaymentTransactionEMVTags.EMV_TAG_8A EMV Secondary receipt data and related mapping to the metadata entity attributes. Link for sample receipt. EMV Secondary fields Mapping Application Version Number PaymentTransactionEMVTags.EMV_TAG_9F09 Application Usage Control PaymentTransactionEMVTags.EMV_TAG_9F07 Application Identifier (AID) – card PaymentTransactionEMVTags.EMV_TAG_9F06 Issuer Action Code – Default PaymentTransactionEMVTags.EMV_TAG_9F0D TacDefault PaymentTransactionEMVTags.TAC_DEFAULT Issuer Action Code – Online PaymentTransactionEMVTags.EMV_TAG_9F0F Issuer Action Code – Denial PaymentTransactionEMVTags.EMV_TAG_9F0E Application Preferred Name PaymentTransactionEMVTags.EMV_TAG_9F12 CARD ENTRY MODE PaymentTransactionEMVTags.CARD_ENTRY_MODE Issuer Code Table Index PaymentTransactionEMVTags.EMV_TAG_9F11 Application Primary Account Number (PAN) Sequence Number PaymentTransactionEMVTags.EMV_TAG_5F34 Terminal Action Code – Denial PaymentTransactionEMVTags.TAC_DENIAL Transaction Type PaymentTransactionEMVTags.EMV_TAG_9C Transaction Date PaymentTransactionEMVTags.EMV_TAG_9A Point-of-Service (POS) Entry Mode PaymentTransactionEMVTags.EMV_TAG_9F39 Terminal Action Code – Online PaymentTransactionEMVTags.TAC_ONLINE Amount, Other (Numeric) PaymentTransactionEMVTags.EMV_TAG_9F03 Amount, Authorised (Numeric) PaymentTransactionEMVTags.EMV_TAG_9F02 EmvMode PaymentTransactionEMVTags.EMV_MODE Cryptogram Information Data PaymentTransactionEMVTags.EMV_TAG_9F27 Transaction Currency Code PaymentTransactionEMVTags.EMV_TAG_5F2A EmvChipIndicator PaymentTransactionEMVTags.EMV_CHIP_INDICATOR Dedicated File (DF) Name PaymentTransactionEMVTags.EMV_TAG_84 Application Interchange Profile PaymentTransactionEMVTags.EMV_TAG_82 Unpredictable Number PaymentTransactionEMVTags.EMV_TAG_9F37 Application Transaction Counter (ATC) PaymentTransactionEMVTags.EMV_TAG_9F36 Terminal Type PaymentTransactionEMVTags.EMV_TAG_9F35 Cardholder Verification Method (CVM) Results PaymentTransactionEMVTags.EMV_TAG_9F34 Terminal Capabilities PaymentTransactionEMVTags.EMV_TAG_9F33 TermId PaymentTransactionEMVTags.TERMID Interface Device (IFD) Serial Number PaymentTransactionEMVTags.EMV_TAG_9F1E Terminal Country Code PaymentTransactionEMVTags.EMV_TAG_9F1A Application Cryptogram PaymentTransactionEMVTags.EMV_TAG_9F26 Transaction Time PaymentTransactionEMVTags.EMV_TAG_9F21 MERCHID PaymentTransactionEMVTags.MERCHID Deposits Orders containing only Omni (STA/STS/PAS) items will qualify for partial payments (deposits). On the Order Summary screen, once a partial payment is made, the Deposit button will be available based upon a grant.  If the Deposit button is selected, the order will be marked as partially paid and the order will progress to the receipt screen.   From the Order Search screen, the order can be selected and viewed.  The Order Detail screen will indicate the order is awaiting further payment and an option will be available to make additional payments.   If an additional payment is selected, the Order Summary screen will be displayed with the previously applied payment(s) and allow for either partial or full payment. Note: This feature  requires the Upgraded Store Application.  See Upgraded Store Application for more information. Custom Tender Creation The default supported payment types include cash, check, credit card, debit, e-check, gift card, PayPal, store credit, and traveler's check. Additional custom payment types can be configured as required. Custom Payment Types Custom payment types can be added as required. Newly created payment types can be used for both purchases as well as refunds. The payment configuration indicates how to process the payment type. Private Label Credit Card A Private Label Credit Card (PLCC) is a custom integrated payment type which a client may accept as tender in store. PLCC payment processing is typically characterized as"Stored Value Services", no processing over major card brand networks, valid only with the brand. As such, PLCC is typically not subject to PCI-DSS stipulations. If the PLCC is processed over major card brand networks, is branded with a logo of a major card network, or is accepted outside of the client’s selling operations, the payment type may be subject to PCI-DSS. Please, coordinate between the client and MA legal team as needed. Configuring a Single Card Option for Both Credit and Debit Payments If your business needs to display only one card option in the payment screen to handle both Credit and Debit transactions, you can achieve this through the following configuration steps: Edit the Credit Card Configuration: Navigate to the Payment Type configuration section and select the Credit Card configuration to edit. Update the Display Name from "Credit Card" to "Card." Save the configuration. Remove the Debit Card Configuration: In the Payment Type configuration, delete the Debit Card configuration. Adjust the Payment Capture Settings: Go to the Payment Capture Configuration and select the Credit Card option. In the Payment Capture Configuration Detail tab, disable the flag labeled "Set payment type on gateway request." Save the configuration. After making these changes, the payment options screen will only display "Card" as an option, allowing customers to use either a Credit or Debit card on the terminal. Payment Capture Configuration The behavior of payment types at POS is configurable via the Payment Capture Configuration utility.  In addition to basic behavior, custom configurations can be added to base tenders as well as custom tenders.  See the POS Payment Configuration guide for details. The configurations will determine the following within the UI flow: Capture customer Information and Identity Documents Input Entry Required Input Entry Type Authorization required through payment terminal Franking required Capture denominations Pop cash drawer and include in drawer count Capture customer signature Delay Payment Terminal Session Until Time of Payment Pay By Link POS Note: Ability to delete base tender, part of user-created profile. Owner of that profile has full control to create/delete entries. Retailers can configure an order to be paid by credit/debit/gift card via an email link or QR code.   Instead of the customer swiping/tapping/inserting their card at the payment terminal, they can opt to have a link sent to them via email or scan a QR code at the POS terminal to access the payment link. To do this, the retailer must first configure the Pay By Link as described in POS Payment Configuration. Pay By Link Workflow diagram Note: Pay by Link by SMS/Text is not currently supported out of base POS.  This would require further integration with a provider - for example, Twilio.  Base deployments should use the "hide" metadata extension provided to hide the SMS option on the Order Summary screen, as it is not relevant at this time. When an associate selects “Pay By Link", the options for how to send the link (email, QR CODE) will be displayed based upon configuration through extensions.  Providing an email  was previously entered in the transaction, it will be prepopulated for Pay By Link.   The opt-in preferences of the customer will not be checked for Pay By Link (i.e. if the customer opted out of email but asked to pay by link via email, the link will be sent via email).   All current POS error checking for email will be utilized. Once a valid email  is entered, the associate will select the “Send Link” option.  After the QR Code is scanned or the email is sent, the associate will advance to the “Waiting for Customer” screen with the email displayed.  The associate can cancel out and return to the Order Summary screen (if the payment has not yet been approved) or check the status of the payment.  Providing the payment is approved, the associate will advance to the receipt screen.  If the payment was not approved, the associate will be informed to wait and recheck the status.  If the payment failed (i.e. gateway timeout), an error message will be displayed to the user that the payment will be cancelled and the transaction will be abandoned. Pay By Link will be for positive totals only (in store, send sale, BOPIS, Ship to address) and uneditable for the entire amount due. User Input Forms User input forms can be created to capture additional payment attributes for various tenders.  Retailers can configure the fields per form, as well as the field sequence, form input method (Keyboard, Scanner and so on), and the form displays sequence for more than one form to be created for a tender.  Additionally, forms have context for sales vs returns. See the flow below.  User Input forms are only available for non-cash tenders for which Auth through Terminal is False. Tender Franking Retailers can configure endorsements to be franked on the back of any tender.  To do this, they must first configure the tender to frank on redemption, and then configure the data to be franked at the time the tender is selected. For additional details, please refer to POS Payment Configuration. For each tender selected, the frank occurs after any required input data has been captured.  If no input data is required, then the frank will occur once the user presses Complete Payment. Note: Franking is only supported in portrait mode.  For example: User will need to remove personal check once MICR has been successfully read, and re-insert face down into the printer. Important: Currently tender franking can only be used on a windows machine with the Epson TM-6000IV printer. Sharing Payment Terminals between Mobile Registers - Delay Payment Terminal Session Retailers can configure mobile registers (only) to establish a session with a payment terminal at the time of payment, instead of at the beginning of an order.  This allows for multiple registers to share a single payment terminal, and also allows users to easily switch to a different terminal as needed. When this feature is enabled, the payment terminal will no longer act as a line item display.  To enable this capability, posStoreConfig>storeCommonConfig>delayPTSessionTillPayment should be set to TRUE. When configured, the connected payment terminal will be displayed in the screen header of the Cart and Order Summary.  If no terminal is connected, the display will show N/A.  With the correct permissions, users can tap the payment terminal info, and a popup will appear. With this popup, users can select from a list of pre-configured terminals for the store.  If paring to the terminal is required, the user will then be prompted to do so, else this will act as a selection.  Once selected, the newly connected terminal will display in the screen header.  Additionally, the terminal in the POS Settings screen will be updated and will persist until the terminal is again changed, either in the header or settings screen. The session for the device will not begin until the following: User selects a tender on Order Summary which requires the terminal to collect data or to process (credit, debit, gift card, etc.) User selects to issue or reload a gift card from the Cart User selects a "from" exchange tender which requires a payment terminal If a session is started in the Cart, due to a gift card activate or reload,  where "Activate Gift Card in Cart" is true, the session will not end until the transaction is complete. The same will hold true for Exchange tenders where the "from" tender requires the payment terminal. If a partial payment has been made which established a session, the session will not be released until the user voids the partial payment and either returns to the Cart or completes the transaction. A register will not be able to engage an associated payment terminal while the terminal is actively engaged with another register, but can do so after the session is terminated. If another user attempts to establish a session with a payment terminal that is currently engaged, they will be notified and can try again once the other register has completed its transaction, or they can again go into the payment terminal popup to switch to another payment device. The session release will occur after the receipt has been printed or emailed, and the terminal will then become available for the next transaction. Note: This feature is for mobile register type only. Fixed terminals will continue to start the session upon order initiation and will continue to be used for line display of items. Exchange Tender (ET) Transactions Exchange tender in Active Store solution offers the retailers to accept a tender and refund the customer with another tender. Both the tenders i.e. the tender exchanged and the list of available refunded tender are configurable. The exchange refunded will be the same amount the tender is worth or the customer is charged on the tender to be exchanged. Exchange tender cannot be done partially and is always done for the full amount available on the tender to be exchanged. Exchange tender is a separate transaction by itself and cannot be combined in any existing sale/return/gift card/backoffice transactions. This feature is controlled by a specific UI grant, "ui::posservice::exchangetender".  Users with grant can perform this transaction else the menu option is not available. Every such transaction allows multiples of a single tender type to be exchanged. A typical exchange tender flow is mentioned below: Select EXCHANGE TENDER function.  Application generates a unique exchange tender transaction ID when Exchange Tender option is selected. Select the type of tender to be exchanged. (This is dependent on the configuration; only applicable tenders can be exchanged). Accept the tenders to be exchanged and get the balance available on this tender from either third-party or from payware or based on the user input configurations. The maximum amount allowed to be exchanged is based on configuration. Any amount above this is not allowed. Charge/settle the full funds from the tender to be exchanged. (Partial processing of funds is not supported.) Get the list of eligible refund tenders. This is the list of tender types to which the amounts get refunded to. Select the refund tender and enter the amount to be refund and process the refund. Refund can be split across different tender types. If any of the tender types requires to be placed in/out of cash drawer, then cash drawer opens when the refund balance=0. Exchange tender does not support below features: A completed Exchange tender transaction cannot be post voided. Exchange tender transaction is not eligible to be returned. Exchange tender transactions cannot be suspended. Tenders with no balance is not eligible for exchange and is not accepted on UI as valid tender. Different types of tenders cannot be exchanged under the same exchange tender transaction. Partial amount exchange of any tender is not supported. ET Workflow diagram If a transaction ID was generated incorrectly or by accident, then the exchange tender transaction can be voided.  If a tender is added to transaction and customers wants to remove, it can be selected and voided from the transaction before charging funds from the tenders. ET - Associating a customer Exchange tender transaction can be linked to a customer. After generating the exchange tender transaction ID, associates can use "Tap to Apply" option on the header and search for a customer and activate to link the customer to this transaction. Once any customer is linked it cannot be modified further to change to another customer. ET - Charging the tender to be exchanged When all the tenders to be exchanged are added in the exchange tender screen, user can click on Proceed. On clicking proceed, each tender is picked one at a time in the order in which they were added for charging.  The removal of refunds is the amount available on the tenders and this will create a settlement records for every tender added on the payment component. Error handling: If the only tender which is to be exchanged fails and retailer is not able to remove funds then app will error out and associate cannot proceed, then the associate either needs to retry or void this tender/transaction. Else if some amount of the tender to be exchanged fails and there is still some positive amount that was removed from the tender and needs to be refunded, then the associate will be proceeded to the Summary screen to allow the refund. ET - Payback process Based on the configuration, only selected tender is eligible as refund tender. And each tender has a maximum amount. Any amount above maximum limit is not allowed to be refunded for a selected refund tender. User can choose to split the refund across multiple tenders based on the configuration. Handling cash drawer and till updates: If any refund tender requires engaging a cash drawer (config, popCashDrawer=TRUE), then cash drawer is opened and funds are removed from the cash drawer and closed. Till is also updated in the backoffice for the specific amount drawn from the till. If the tender which is to be exchanged requires engaging a cash drawer, then cash drawer is opened and funds are inserted into the cash drawer and closed. Till is also updated in the backoffice for the specific amount inserted into the till. If the tender which is to be exchanged does not require engaging a cash drawer but requires only till updates i.e. includeDrawerCount = TRUE, then cash drawer is not engaged but funds are inserted into the cash drawer. Only till updates are performed in the backoffice for the specific amount inserted into the till. ET - Receipt and Reprint Once all the amount is refunded and the balance to be refunded = 0, then the application navigates to the receipt screen. User can choose to print or email the exchange tender transaction. The receipt contains list of tenders from where the funds are transferred to with the amount details and the list of tenders to which the funds are transferred along the amount details. Note: Reprinting of an exchange tender transaction is supported using reprint last transaction or from the customer purchase history screen. Note: If "Capture customer Info" or "Capture Cust Id" is turned ON for specific tender, then for Exchange Tender scenario we will skip these screens as it is not applicable. Exchange Tender transaction are all non-taxable. Gift card Cash out When gift card is used to tender a transaction and its remaining balance goes very low, retailer can provide the ability to cash this out.  By this, the customer does not have to carry gift card with low balance on it.  This also reduces the number of active gift cards the retailer must maintain.  In case there is any balance to be satisfied, system tries to apply the remaining gift card amount towards this and rest gets cashed out.  The balance amount which is eligible for cash out is configurable under payCaptureConfig.CashOutThreshold. GC cashout always returns money to customer in the form of Cash. Its not configurable. Once tendered, system validates the remaining balance with the threshold defined.  If it has reached the eligible balance, prompts the option to cash out.  If the customer chooses to, the balance amount is settled and gets utilized towards the remaining balance to be satisfied or cash out. Example: The threshold limit is set to 5.00.  Customer uses a Gift card with 100.00 balance, pays 98.00, Order balance due=98.00.  With this, the balance remaining is 2 which is eligible for cash out.  If customer chooses the cash out option, 2.00 cash is handed over. Gift card cash out is applicable to "Gift Card" payment type and to "Store/merchadise credit" but not applicable to any other payment type. Payment Hardening and Failure Handling Especially for payment types such as Credit, Debit, or Gift Cards which require authorization via a payment terminal and payment gateway, there can be scenarios during the day in a store, where transactions can be abandoned during a payment capture process due to various reasons such as (battery drain, network issues, gateway error etc) and thus the response from payment gateway is not captured on Manhattan Active solution.  Depending on the failure, in these cases the user may able to attempt payment with another tender, but sometimes the transaction must be abandoned.  If the customer has started interaction with the payment terminal prior to the network, device, or gateway failure, in such scenarios application would not know if the customer was charged on the gateway to start any process of reverting the payment. This problem will be systematically handled by capturing the payment request as logs before making the call to gateway and subsequently calls. When there are any discrepancies, the logs can be queried for all unconfirmed payments and checked with the gateway for any delta for reconciliation. RequestLogs/UniqueId As mentioned above all payment request needs to be save before placing the call to payment gateway or Manhattan Active solution. The needs to be logs are saved at every touch point with the gateway and payment component. Please refer the above workflows for various touch points. Also check below the life cycle of the requestLog for any payment transaction. Create an uniqueId, well known as referenceId which needs to be saved on requestLogs entity and same id is sent as part of all payment request to the gateway and to payment transaction on cloud server. UniqueId is required to identify the payment on gateway and map that with the payment transaction on cloud server. This mapping will help to find the discrepancies for further reconciliation. Before making a call to MX terminal - Create requestLogs data in "Created" status along with uniqueId and payment request to be sent to gateway. If MX terminal is used flag, processThroughTerminal = TRUE, and if 3rd party application is used, then flag processThroughThirdParty = TRUE while saving the data to requestLogs. After successful response from gateway - Save the response from gateway for the same uniqueId for which the request was sent and update the status as "Processed". Use this uniqueId from gateway and create request to save this uniqueId as paymentTransactionId on Manhattan Active solution (payment component). (For example: AddTender API) After successful response from Manhattan Active solution (payment component), save the response on requestLogs as "Completed". Note: The base mapping to save gateway response on Manhattan Active solution (payment component) is with respect to "Payware connect", if retailers are using other gateway then refer user exits documentation to handle mapping to save the payment transaction. Note: The plugin changes will also be required to create payment request and send uniqueId as part of referenceId or additional attribute that gateway provides, if retailers are using other gateway other than "Payware connect". Hardening workflow Handling Communication error There can be communication errors from the payment terminal device, the gateway or from the Manhattan Active solution (Payment Component) which need to be handled in our application.  When such a communication error occurs, the application will perform a get call to gateway or to the payment component 3 times to get the status. Please check below on the possible outcomes if all three attempts fail. MAO POS has recently developed an improved failure handling process that will result in fewer abandoned transactions and more flexible options for the user. Note: The improved Failure Handling is controlled by Change in Behavior "POS Payment Failure Handling". See the Behavior Change documentation. The new Failure Handling process will be enabled for any new customer environments created after Release 23.1. It will not be immediately enabled for existing customer environments.  Existing customers may enable the new process after Release 23.1 and should do so in testing environments. It will be automatically enabled for them by the end of 2023. The legacy process will be deprecated and no longer available as an option by 30-Dec 2023. Prior to Release 23.1- Legacy Comm failure handling Error from gateway - if get call = found, and update requestLogs as "Processed" and move forward to confirm the order or partial payment. Error from gateway - if get call = not found, go back to summary screen and update requestLogs as "Reconciled" so that they are not considered durng EOD Payment reconciliation. If the request had failed, this logic is appropriate. If the request had succeeded, this is a logical gap. Associate must request customer to pay again, however, the not found but 'reconciled' payment record may cause duplicate charges. Error from gateway - if get call receives communication error (no response). Request log is created with status CREATED. No payment transaction is created. Abort the Order transaction, return user to empty cart. At end of day, payment reconciliation process will query the gateway and cleanup the data by creating and canceling (if needed) a payment transaction for the one that couldn't be created at transaction time -other cleanup may occur if payment not found in gateway at all, etc. Legacy Workflow Following Release 23.1- Flexible Comm failure handling Error from gateway - if get call = found, and update requestLogs as "Processed" and move forward to confirm the order or partial payment, as appropriate. Error from gateway - if get call = not found, go back to summary screen.  With new functionality do NOT update requestLogs as "Reconciled". Since logs are left unreconciled ("Created") they will be cleaned up as part of EOD Payment reconciliation. Allow user to try same or alternate payment method again Error from gateway - if get call receives communication error (no response), the new flow is the same as "not found" above. Leave logs unreconciled Since logs are left unreconciled ("Created") they will be cleaned up as part of EOD Payment reconciliation. Allow user to try same or alternate payment method again Payment Reconciliation Payment reconciliation is a process of correcting the erroneous payment transaction with the payment gateway, the error can be when payware or payment component response resulted in communication error and where payment has gone through the point gateway but not saved on our payment component because of error in response from payware. The requestLogs data for such payment transaction will be in "created" or "processed" status, Such data is picked to revisit these transactions on gateway by performing a transsearch api call using the invoice # and check if these transaction made to payment, if not then capture payment component for reversal with point gateway. Fetch gateway token for SAF transactions: The first step in Payment reconciliation is to fetch gateway if there were any store and forward transaction processed during the day. Please check below steps. Find all SAF transactions without gateway token. Check the reconciliation retry limit (pos general config > reconciliationRetryLimit) , if the saf transaction has not reached the retry limit (everify the latest limit on reconciliationLogs) then pick this transaction for SAF reconciliation. Place a transsearch api call using invoice# and on successful response from the gateway, save the response of gateway token on requestLogs and payment component. Update reconciliationlogs for the SAF reconciliation attempt. If transsearch api call using invoice# and on unsuccessful then update reconciliationLog with a link to parent requestLog ID as [reconciliationType = SAF, numberOfRetry = runningNumber, retryLimit= {fromConfig}, reconciliationStatus =Failed, requestData = {sent to gateway}, responseData = {received from gateway}] Note: Milestone job (which run every 2 hours) will not picked abandoned orders in readyForTender = TRUE status. Work Flow of payment reconciliation Reconciliation process is called within the store close operations and has the follow steps: Perform SAF reconciliation as explained above for below data on requestLogs data and reconciliation retry limit is not reached. SAF# or Voice Auth Present + ( requestLog status =Completed ) + Payment have this uniqued Id i.e. Processed. SAF# or Voice Auth Present + ( requestLog status =Processed) + Payment have this uniqued Id i.e. Processed. SAF# or Voice Auth Present + ( requestLog status =Created) + Payment does not have this uniqued Id i.e. Created. Perform the actual reconciliation for all below kind (reconciliation process is explained below). requestLogs status = Processed, PTT=True, 3rd Party False + Payment processed. requestLogs status = Processed, PTT=False, 3rd party False +Payment processed. (Should be taken care in user exit) requestLog status = Processed + PTT=False, 3rd party TRUE +Payment processed. (Should be taken care in user exit) requestLog status = Created + PTT=True + Payment NOT processed. Reconciliation Process Outline Validate if the requestLog status = processed or created. Then check the PTT flag, if its true Then, check 3rd party = false, if its false, Then goto payment component and check if the payment transaction with this unique Id exists. If exists then do below: Validate Payment transaction status = Closed or Open If Payment transaction status = Open , and mark requestLog status = reconciled. And If not already present update Payment transaction with the CTROUTD, TROUTD and other payment details from the gateway. If Payment transaction status = Closed, further mark requestLog status = reconciled Then update reconciliationLog as Passed with other details. If does not existing on payment component then perform transsearch api call on gateway using the invoice # Validate the transsearch response with the payment component for this invoice and find the delta in payment component. For all the delta, create payment transaction in open status and mark requestLog status = reconciled Update reconciliationLog as passed with other details. Refresh Payment Retailers who use non-base pay by link or pay via an external website can add a Refresh option to the Order Summary screen.  When the Refresh option is selected, it will go out and obtain the Payment Status.  If the payment was approved, the balance due will be decreased accordingly. The grant for this function ui::posservice::refreshtender. Services The following APIs are related to payment. Refer to the API documentation for additional details on each service. Service Component Group Service Endpoint Close Invoice Order Order Services /order/api/order/order/orderId/{orderId}/invoiceProcessedAmount Get Order Order Order Services /order/api/order/order Get Order Value Order Order Services /order/api/order/order/getOrderValue Get Payment Header Payment PaymentHeader Services /payment/api/payment/paymentHeader Get Payment Status Payment PaymentStatus Services /payment/api/payment/paymentStatus Save Payment Header Payment PaymentHeader Services /payment/api/payment/paymentHeader/save Save Payment Request Payment PaymentRequest Services /payment/api/payment/paymentRequest/save Total Payment Summary Payment payment-summary-controller /payment/api/payment/paymentSummary/total/orderId/{orderId} Exchange Tender Transaction posservice Order Service POST /api/posservice/order/addAttributeToOrder Transaction void posService POS Service POST /api/posservice/override/command/transVoid Balance Enquiry posservice Payment Transaction Service POST /api/posservice/payment/addGiftItemBalance Add Tender posservice Payment Header Service POST /api/posservice/payment/addTender Update Ready for Tender posservice Payment Service POST /api/posservice/order/updateReadyForTender Add Refund Tender posservice Payment Header Service POST /api/posservice/order/addRefundTender Search Customer Search Search Service GET /api/search/customer Activate Customer Search Search Service GET /api/search/customer/customerId Save requestLogs posservice Request Logs Service POST /api/posservice/requestLogs/save Save reconcileLog posservice Reconciliation Logs Service POST /api/posservice/reconcileLog/save SAF Payment Reconciliation posservice Payment Reconciliation Service POST /api/backoffice/backofficeTransaction/SAFTransaction/updateTokenInfo Payment Reconciliation posservice Payment Reconciliation Service POST /api/backoffice/backofficeTransaction/paymentReconciliation