# POS Metrics - Aggregation Framework

**Permalink:** pos-metrics-aggregation-framework
**Path:** Manhattan Active® Omni/Store/Process & Configuration Guides/Point of Sale/POS Classic Guides/POS Metrics - Aggregation Framework/POS Metrics - Aggregation Framework
**Content Length:** 43,075 characters
**Scraped:** 2025-08-09T22:03:08.970493

---

Home ››Manhattan Active® Omni››Store››Process & Configuration Guides››Point of Sale››POS Classic Guides››POS Metrics - Aggregation Framework ››POS Metrics - Aggregation Framework POS Metrics - using Aggregation Framework Fetching Sales metrics using Aggregration frameworkReport Configs TypesFieldType as InputFieldType as OutputCommonUtilAggregation Framework - EnablementAggregation Framework Metrics configurationAll configurations below need to be performed to fetch the metrics data using aggregation framework method:Order ConfigurationKV Store properties: Add below to enable the Producer framework in order componentPOS Service ConfigurationKV Store properties: Add below to enable the Producer framework in posservice componentScheduler ConfigurationKV Store properties: Add "agg-omni::ago" as comma separated value to "com-manh-cp-scheduler" component in "scheduler.components" fileAGG-OMNI - Omni ConfigurationAdd Aggregation Rule in agg-omniServices MAO-POS features a framework for collecting summary metrics in real time, and using these for reporting and dashboard-type display within the POS app.  This framework is replacing the earlier Wiretap strategy for collecting Sales Metrics. Fetching Sales metrics using Aggregration framework Aggregation FW uses an event producer framework to get the data and aggregate data in-memory based on aggregationEvent configured. Store Sales metrics uses agg-omni component, which performs the aggregation and saves the aggregated data in a configured entity present in agg-omni component. Agg-omni component will have 2 entities TargetAuditEntity as well as TargetEntity for storing metric related data. TargetAuditEntity is where individual record-level aggregated data is stored. For eg for Order this entity holds the data per OrderId. TargetEntity is where the final aggregated data will be stored. For store sales metrics there are two entity data that gets published to agg-omni component. Order Data → Order Component publishes order data, whenever order gets confirmed. eventStrategy is configured in order component to post the order payload to agg-omni component. CustomerVisitTracker → Posservice component publishes CustomerVisitTracker payload each time a record is created. eventStrategy is configured in posservice component to post the CustomerVisitTracker payload to agg-omni component. Refer to the configurations below for store sales metrics. Report Configs Types ReportConfig has ReportFieldConfig child entity which is of mainly 3 types. FieldType as Input These fields act as where condition in fetching data from aggregated data. Considering the example below, TargetEntity will have field LocationId and while fetching results query will be fired with LocationId = <Current Store’s LocationId> { "FieldName": "LocationId", "FieldType": "Input", "QueryClauseType": { "QueryClauseTypeId": "Term" }, "FieldDataType": { "FieldDataTypeId": "Text" }, "DisplayName": "Store Id" } FieldType as Output FieldType as Output with GroupName populated. GroupName will be a targetEntity and MerchSaleItemsSubtotal will be field in the targetEntity. Value of MerchSaleItemsSubtotal will be passed as such in response.  Example below. { "FieldName": "MerchSaleItemsSubtotal", "FieldType": "Output", "FieldDataType": { "FieldDataTypeId": "BigDecimal" }, "DisplayName": "Number of Merch Items Sold", "GroupName": "ConfirmedOrderLineStats" } FieldType as Output and with Expression populated.   These fields are derived using expressions post the value of fields is fetched from TargetEntity. Considering example below, MerchSaleItemsSubtotal and MerchReturnItemsSubtotal were output fields and FlashSales value will be dynamically calculated using expression and returned back in response. { "FieldName": "FlashSales", "FieldType": "Output", "FieldDataType": { "FieldDataTypeId": "BigDecimal" }, "Expression": "MerchSaleItemsSubtotal- abs(MerchReturnItemsSubtotal)", "DisplayName": "Flash Sales" } CommonUtil Data Retrieval and Report generation - the Commonutil component houses logic to expose the APIs to generate reports and metrics.  This includes the logic and metadata to generate, customize, and localize POS reports. This APIs is used with both Wiretap and Aggregation framework data capture strategies. Aggregation Framework - Enablement Store Sales Metrics data will be pulled from Aggregation Framework, if the Change in behaviour is enabled. Behavior Flag = "Switch sales metric data to aggregation framework". Learn more about behavior change enablement from here.  Metrics customization/configuration capability with Aggregation framework is defined in detailed here Selected metrics can be exposed on the POS screens for snapshot 'dashboard' display.  See the Metrics sections of POS Selling Process Guide and POS Cart Configuration Guide. User should have appropriate grant. Below, Sales Metrics Configurations are applicable to enable the framework to capture the required data. 1. Existing customer environments - Sync these base profile purposes into your org cut::reportConfig 2. Import new reportConfig seed data if necessary via this API.  Note that the Report Config seed data contains not only definitions for each of the metric fields but also defines the base .pdf template for the Z report. POST {{url}}/commonutil/api/commonutil/reportConfig/save Aggregation fw - Commonutil ReportConfig { "ReportName": "SaleMetricsReport", "Description": "Base Sale Metric Report", "PurgeAfterDays": 2555, "FetchRealTimeData": true, "ReportFieldConfig": [ { "FieldName": "OrganizationId", "FieldType": "Input", "QueryClauseType": { "QueryClauseTypeId": "Term" }, "FieldDataType": { "FieldDataTypeId": "Text" }, "DisplayName": "OrganizationId" }, { "FieldName": "LocationId", "FieldType": "Input", "QueryClauseType": { "QueryClauseTypeId": "Term" }, "FieldDataType": { "FieldDataTypeId": "Text" }, "DisplayName": "Store Id" }, { "FieldName": "MerchSaleItemsSubtotal", "FieldType": "Output", "FieldDataType": { "FieldDataTypeId": "BigDecimal" }, "DisplayName": "Number of Merch Items Sold", "GroupName": "ConfirmedOrderLineStats" }, { "FieldName": "MerchReturnItemsSubtotal", "FieldType": "Output", "FieldDataType": { "FieldDataTypeId": "BigDecimal" }, "DisplayName": "Number of Merch Items Returned", "GroupName": "ConfirmedOrderLineStats" }, { "FieldName": "NbrOfMerchItemsSold", "FieldType": "Output", "FieldDataType": { "FieldDataTypeId": "BigDecimal" }, "DisplayName": "Number of Sale Orders", "GroupName": "ConfirmedOrderLineStats" }, { "FieldName": "NbrOfMerchItemsReturned", "FieldType": "Output", "FieldDataType": { "FieldDataTypeId": "BigDecimal" }, "DisplayName": "Number of Return Orders", "GroupName": "ConfirmedOrderLineStats" }, { "FieldName": "MerchTotalOrderCount", "FieldType": "Output", "FieldDataType": { "FieldDataTypeId": "Integer" }, "DisplayName": "Total Order Count", "GroupName": "ConfirmedOrderStats" }, { "FieldName": "CustomerEntryCount", "FieldType": "Output", "FieldDataType": { "FieldDataTypeId": "Integer" }, "DisplayName": "Number of store customer visits", "GroupName": "CustomerCounterStats" }, { "FieldName": "OrderCountWithActiveCustomer", "FieldType": "Output", "FieldDataType": { "FieldDataTypeId": "Integer" }, "Expression": "", "DisplayName": "Units Per Transaction", "GroupName": "ConfirmedOrderStats" }, { "FieldName": "FlashSales", "FieldType": "Output", "FieldDataType": { "FieldDataTypeId": "BigDecimal" }, "Expression": "MerchSaleItemsSubtotal- abs(MerchReturnItemsSubtotal)", "DisplayName": "Flash Sales" }, { "FieldName": "UnitsPerTransaction", "FieldType": "Output", "FieldDataType": { "FieldDataTypeId": "BigDecimal" }, "Expression": "(NbrOfMerchItemsSold+NbrOfMerchItemsReturned)/MerchTotalOrderCount", "DisplayName": "Units Per Transaction" }, { "FieldName": "ActiveCustomerCount", "FieldType": "Output", "FieldDataType": { "FieldDataTypeId": "Integer" }, "Expression": "round(OrderCountWithActiveCustomer/MerchTotalOrderCount * 100)", "DisplayName": "Active Customer Count" }, { "FieldName": "Conversion", "FieldType": "Output", "FieldDataType": { "FieldDataTypeId": "Integer" }, "Expression": "round(MerchTotalOrderCount/CustomerEntryCount * 100)", "DisplayName": "Conversion Rate" }, { "FieldName": "DollarsPerTransaction", "FieldType": "Output", "FieldDataType": { "FieldDataTypeId": "BigDecimal" }, "Expression": "(MerchSaleItemsSubtotal + abs(MerchReturnItemsSubtotal))/MerchTotalOrderCount", "DisplayName": "Dollars Per Transaction" } ] } Aggregation Framework Metrics configuration All configurations below need to be performed to fetch the metrics data using aggregation framework method: Order Configuration KV Store properties: Add below to enable the Producer framework in order component manh.changemgmt.entityChangeNotificationEnabled=true manh.cp.eventproducer.event.detection=true Add Event Strategy in order component: Added through Seed data, with default as Active False. Clients adopting needs to mark the event as API - {{url}}/order/api/eventProducer/eventStrategy/save { "EntityStrategyId": "ConfirmedOrderStats", "IsRuleRequired": false, "EntityId": "Order", "Active": true, "IsOldValuesRequired": false, "Component": "com-manh-cp-order", "MessageType": "confirmedOrderEventProcessorMsgType", "DetectionTemplateId": "ConfirmedOrderStatsDetectionTemplate", "TemplateId": "ConfirmedOrderStatsTemplate" } Add outbound in order component: API - {{url}}/order/api/ServiceDefinition/outBoundMessageType/save { "MessageType": "confirmedOrderEventProcessorMsgType", "Description": "Queue to post order data for reporting purpose when order gets confirmed", "Transactional": true, "PersistMessageToMsgStore": false, "ConditionExpression": "isdef IsConfirmed && IsConfirmed" } POS Service Configuration KV Store properties: Add below to enable the Producer framework in posservice component manh.changemgmt.entityChangeNotificationEnabled=true manh.cp.eventproducer.event.detection=true Scheduler Configuration KV Store properties: Add "agg-omni::ago" as comma separated value to "com-manh-cp-scheduler" component in "scheduler.components" file Add EventStrategy for CustomerVisitTracker entity API - {{url}}/posservice/api/eventProducer/eventStrategy/save { "EntityStrategyId": "CustomerCounterStats", "IsRuleRequired": false, "EntityId": "CustomerVisitTracker", "Active": true, "IsOldValuesRequired": false, "Component": "com-manh-cp-posservice", "MessageType": "entity-aggregation-omni", "DetectionTemplateId": null, "TemplateId": null } Add outbound in posservice API - {{url}}/posservice/api/ServiceDefinition/outBoundMessageType/save { "MessageType": "entity-aggregation-omni", "Description": "Entity aggregation event used in fw-entity-aggregation", "Transactional": true, "PersistMessageToMsgStore": false } AGG-OMNI - Omni Configuration 1. Existing customer environments - Sync these base profile purpose into your org ago::messaging Add inbound MessageType for Aggregation listening to order outbound {{url}}/com-manh-cp-agg-omni/api/ServiceDefinition/inBoundMessageType/save { "MessageType": "confirmedOrderEventProcessorMsgType", "ServiceId": "aggregationEventProcessor", "MinNoOfConsumer": 1, "TransformationTemplateId": "confirmedOrderEventFormatter.vm" } Add inbound MessageType in Agg-omni listening to internal outbound {{url}}/com-manh-cp-agg-omni/api/ServiceDefinition/inBoundMessageType/save { "MessageType": "fw-genericAggSummarizer-v2", "NoOfConsumer": 10, "ServiceId": "aggregationSummarizer", "InBoundQueues": { "QueueName": "fw-genericAggSummarizer-v2-ago" } } Add outbound MessageType in Agg-omni {{url}}/com-manh-cp-agg-omni/api/ServiceDefinition/outBoundMessageType/save { "MessageType": "fw-genericAggSummarizer-v2", "Transactional": true, "OutBoundDeliveryConfig": { "OutBoundDeliveryConfigId": "ConsolidateFor20Seconds", "GroupingType": "DEDUPLICATION", "GroupingKeys": "$.AggregationGroupKey", "GroupingInterval": "20 second", "ConsolidationMaxSize": 50, "DeduplicationDeliveryMode": "ENDING" }, "OutBoundQueues": { "QueueName": "fw-genericAggSummarizer-v2-ago" } } Add Aggregation Rule in agg-omni {{url}}/com-manh-cp-agg-omni/api/fw-entity-aggregation/aggregationEvent/import Adding Aggregation Rule for Sales Metrics { "ProfileId": "base", "Data": [ { "EntitysName": "Order", "EventName": "ConfirmedOrderStats", "SourceUniqueKey": "OrderId", "AggregationEventRule": [ { "TargetEntity": "ConfirmedOrderStats", "TargetAuditEntity": "ConfirmedOrderStatsAudit", "RuleName": "MerchTotalOrderCountRule", "TemporalLevel": "Daily", "SourceTemporalFieldName": "BusinessDate", "TargetTemporalFieldName": "AggregationDateTime", "LeafLevel": "Order", "AggregationEventFilter": [ { "FilterPath": "Order", "FilterCondition": "SellingChannel.SellingChannelId = 'Store' AND IsConfirmed = true AND IsPostVoided = false AND IsCancelled = false AND (MerchSaleLineCount > 0 OR MerchReturnLineCount > 0)" } ], "AggregationEventMeasure": [ { "SourceFieldName": "Order.OrderId", "SourceAggregationType": "Counter", "TargetFieldName": "MerchTotalOrderCount", "TargetAggregationType": "Sum" } ], "AggregationEventGroupBy": [ { "SourceFieldName": "Order.SellingLocationId", "TargetFieldName": "LocationId" } ] }, { "TargetEntity": "ConfirmedOrderStats", "TargetAuditEntity": "ConfirmedOrderStatsAudit", "RuleName": "OrderCountWithActiveCustomerRule", "TemporalLevel": "Daily", "SourceTemporalFieldName": "BusinessDate", "TargetTemporalFieldName": "AggregationDateTime", "LeafLevel": "Order", "AggregationEventFilter": [ { "FilterPath": "Order", "FilterCondition": "SellingChannel.SellingChannelId = 'Store' AND IsConfirmed = true AND IsPostVoided = false AND IsCancelled = false AND CustomerId != null AND CustomerId != ''" } ], "AggregationEventMeasure": [ { "SourceFieldName": "Order.OrderId", "SourceAggregationType": "Counter", "TargetFieldName": "OrderCountWithActiveCustomer", "TargetAggregationType": "Sum" } ], "AggregationEventGroupBy": [ { "SourceFieldName": "Order.SellingLocationId", "TargetFieldName": "LocationId" } ] }, { "TargetEntity": "ConfirmedOrderLineStats", "TargetAuditEntity": "ConfirmedOrderLineStatsAudit", "RuleName": "NbrOfMerchItemsSoldRule", "TemporalLevel": "Daily", "SourceTemporalFieldName": "BusinessDate", "TargetTemporalFieldName": "AggregationDateTime", "LeafLevel": "Order.OrderLine", "AggregationEventFilter": [ { "FilterPath": "Order", "FilterCondition": "SellingChannel.SellingChannelId = 'Store' AND IsConfirmed = true AND IsPostVoided = false AND IsCancelled = false" }, { "FilterPath": "Order.OrderLine", "FilterCondition": "IsCancelled = false AND IsNonMerchandise = false AND IsReturn = false" } ], "AggregationEventMeasure": [ { "SourceFieldName": "Order.OrderLine.Quantity", "SourceAggregationType": "Sum", "TargetFieldName": "NbrOfMerchItemsSold", "TargetAggregationType": "Sum" } ], "AggregationEventGroupBy": [ { "SourceFieldName": "Order.SellingLocationId", "TargetFieldName": "LocationId" } ] }, { "TargetEntity": "ConfirmedOrderLineStats", "TargetAuditEntity": "ConfirmedOrderLineStatsAudit", "RuleName": "MerchSaleItemsSubtotalRule", "TemporalLevel": "Daily", "SourceTemporalFieldName": "BusinessDate", "TargetTemporalFieldName": "AggregationDateTime", "LeafLevel": "Order.OrderLine", "AggregationEventFilter": [ { "FilterPath": "Order", "FilterCondition": "SellingChannel.SellingChannelId = 'Store' AND IsConfirmed = true AND IsPostVoided = false AND IsCancelled = false" }, { "FilterPath": "Order.OrderLine", "FilterCondition": "IsCancelled = false AND IsNonMerchandise = false AND IsReturn = false" } ], "AggregationEventMeasure": [ { "SourceFieldName": "Order.OrderLine.OrderLineSubtotalWithDiscount", "SourceAggregationType": "Sum", "TargetFieldName": "MerchSaleItemsSubtotal", "TargetAggregationType": "Sum" } ], "AggregationEventGroupBy": [ { "SourceFieldName": "Order.SellingLocationId", "TargetFieldName": "LocationId" } ] }, { "TargetEntity": "ConfirmedOrderLineStats", "TargetAuditEntity": "ConfirmedOrderLineStatsAudit", "RuleName": "NbrOfMerchItemsReturnedRule", "TemporalLevel": "Daily", "SourceTemporalFieldName": "BusinessDate", "TargetTemporalFieldName": "AggregationDateTime", "LeafLevel": "Order.OrderLine", "AggregationEventFilter": [ { "FilterPath": "Order", "FilterCondition": "SellingChannel.SellingChannelId = 'Store' AND IsConfirmed = true AND IsPostVoided = false AND IsCancelled = false" }, { "FilterPath": "Order.OrderLine", "FilterCondition": "IsCancelled = false AND IsNonMerchandise = false AND IsReturn = true" } ], "AggregationEventMeasure": [ { "SourceFieldName": "Order.OrderLine.Quantity", "SourceAggregationType": "Sum", "TargetFieldName": "NbrOfMerchItemsReturned", "TargetAggregationType": "Sum" } ], "AggregationEventGroupBy": [ { "SourceFieldName": "Order.SellingLocationId", "TargetFieldName": "LocationId" } ] }, { "TargetEntity": "ConfirmedOrderLineStats", "TargetAuditEntity": "ConfirmedOrderLineStatsAudit", "RuleName": "MerchReturnItemsSubtotalRule", "TemporalLevel": "Daily", "SourceTemporalFieldName": "BusinessDate", "TargetTemporalFieldName": "AggregationDateTime", "LeafLevel": "Order.OrderLine", "AggregationEventFilter": [ { "FilterPath": "Order", "FilterCondition": "SellingChannel.SellingChannelId = 'Store' AND IsConfirmed = true AND IsPostVoided = false AND IsCancelled = false" }, { "FilterPath": "Order.OrderLine", "FilterCondition": "IsCancelled = false AND IsNonMerchandise = false AND IsReturn = true" } ], "AggregationEventMeasure": [ { "SourceFieldName": "Order.OrderLine.OrderLineSubtotalWithDiscount", "SourceAggregationType": "Sum", "TargetFieldName": "MerchReturnItemsSubtotal", "TargetAggregationType": "Sum" } ], "AggregationEventGroupBy": [ { "SourceFieldName": "Order.SellingLocationId", "TargetFieldName": "LocationId" } ] } ] }, { "EntitysName": "CustomerVisitTracker", "EventName": "CustomerCounterStats", "SourceUniqueKey": "CustomerVisitTrackerId", "AggregationEventRule": [ { "TargetEntity": "CustomerCounterStats", "TargetAuditEntity": "CustomerCounterStatsAudit", "RuleName": "CustomerEntryCountRule", "TemporalLevel": "Daily", "SourceTemporalFieldName": "CaptureDateTime", "TargetTemporalFieldName": "AggregationDateTime", "LeafLevel": "CustomerVisitTracker", "AggregationEventFilter": [], "AggregationEventMeasure": [ { "SourceFieldName": "CustomerVisitTracker.EntryCount", "SourceAggregationType": "Sum", "TargetFieldName": "CustomerEntryCount", "TargetAggregationType": "Sum" } ], "AggregationEventGroupBy": [ { "SourceFieldName": "CustomerVisitTracker.LocationId", "TargetFieldName": "LocationId" } ] } ] } ] } Services The APIs listed in the following table are referenced in this document. Refer to the API documentation for additional details on each service. Service Component Group Service Endpoint Report Config CommonUtil ReportConfig Services POST /commonutil/api/commonutil/reportConfig/save Event Producer Order Event Producer Services POST /order/api/eventProducer/eventStrategy/save Event Producer POS Service Event Producer Service POST /posservice/api/eventProducer/eventStrategy/save Customer Entry Count POS Service Customer Visit Tracker Services POST /posservice/api/posservice/customerVisitTracker/save